const __vite__fileDeps=["assets/index-BOasm-Qm.js","assets/react-core-BE3w-k5R.js","assets/semi-ui-eTHMSREL.js","assets/semi-ui-OcI8ZdEr.css","assets/tools-BD_dY_tN.js","assets/react-components-CXZTIyra.js","assets/semantic-m2SYSARb.js","assets/index-DN2MlcQs.js","assets/visactor-D2-xo_Y3.js","assets/index-BW2WmlmC.js"],__vite__mapDeps=i=>i.map(i=>__vite__fileDeps[i]);
import{r as n,a as dt,u as Se,N as ht,L as eu,R as nu,e as ku,f as Ft,h as mt,i as pt,j as Fe,B as gt}from"./react-core-BE3w-k5R.js";import{S as Ue,T as _e,e as S,f as su,g as Ge,h as ie,B as v,F as se,i as V,j as Ae,D as Fu,k as ee,l as Je,m as Le,P as De,L as le,I as Hu,C as qe,n as Ru,o as xt,M as je,R as Et,p as Ct,q as au,r as Bu,A as _u,s as Me,t as jt,u as ft,v as yt,w as ju,x as Du,y as Au,z as qu,E as $e,G as Qu,H as Bt,J as bu,K as Ju,N as Dt,O as At,Q as bt,U as ze,V as wt,W as Vu,X as Yu,Y as St,Z as vt,$ as kt,a0 as _t,a1 as Tt,a2 as It,a3 as Pt,a4 as Rt,a5 as Mt}from"./semi-ui-eTHMSREL.js";import{c as Lt,a as $t}from"./tools-BD_dY_tN.js";import{Q as Ot,_ as Qe,T as Zu,f as fu,k as zt}from"./react-components-CXZTIyra.js";import{G as Te,H as ce,I as Tu,F as d,S as gu,B as Ne,M as mu,D as ge,a as cu,b as Nt,L as Ut}from"./semantic-m2SYSARb.js";(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))s(i);new MutationObserver(i=>{for(const l of i)if(l.type==="childList")for(const c of l.addedNodes)c.tagName==="LINK"&&c.rel==="modulepreload"&&s(c)}).observe(document,{childList:!0,subtree:!0});function a(i){const l={};return i.integrity&&(l.integrity=i.integrity),i.referrerPolicy&&(l.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?l.credentials="include":i.crossOrigin==="anonymous"?l.credentials="omit":l.credentials="same-origin",l}function s(i){if(i.ep)return;i.ep=!0;const l=a(i);fetch(i.href,l)}})();var Xu={exports:{}},xu={};/**
 * @license React
 * react-jsx-runtime.production.min.js
 *
 * Copyright (c) Facebook, Inc. and its affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */var Gt=n,Wt=Symbol.for("react.element"),Kt=Symbol.for("react.fragment"),Ht=Object.prototype.hasOwnProperty,qt=Gt.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED.ReactCurrentOwner,Qt={key:!0,ref:!0,__self:!0,__source:!0};function et(u,t,a){var s,i={},l=null,c=null;a!==void 0&&(l=""+a),t.key!==void 0&&(l=""+t.key),t.ref!==void 0&&(c=t.ref);for(s in t)Ht.call(t,s)&&!Qt.hasOwnProperty(s)&&(i[s]=t[s]);if(u&&u.defaultProps)for(s in t=u.defaultProps,t)i[s]===void 0&&(i[s]=t[s]);return{$$typeof:Wt,type:u,key:l,ref:c,props:i,_owner:qt.current}}xu.Fragment=Kt;xu.jsx=et;xu.jsxs=et;Xu.exports=xu;var e=Xu.exports,wu={},Mu=dt;wu.createRoot=Mu.createRoot,wu.hydrateRoot=Mu.hydrateRoot;const Jt="modulepreload",Vt=function(u){return"/"+u},Lu={},Iu=function(t,a,s){let i=Promise.resolve();if(a&&a.length>0){document.getElementsByTagName("link");const l=document.querySelector("meta[property=csp-nonce]"),c=(l==null?void 0:l.nonce)||(l==null?void 0:l.getAttribute("nonce"));i=Promise.all(a.map(f=>{if(f=Vt(f),f in Lu)return;Lu[f]=!0;const R=f.endsWith(".css"),O=R?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${f}"]${O}`))return;const L=document.createElement("link");if(L.rel=R?"stylesheet":Jt,R||(L.as="script",L.crossOrigin=""),L.href=f,c&&L.setAttribute("nonce",c),document.head.appendChild(L),R)return new Promise((j,_)=>{L.addEventListener("load",j),L.addEventListener("error",()=>_(new Error(`Unable to preload CSS for ${f}`)))})}))}return i.then(()=>t()).catch(l=>{const c=new Event("vite:preloadError",{cancelable:!0});if(c.payload=l,window.dispatchEvent(c),!c.defaultPrevented)throw l})},fe=({prompt:u="page"})=>e.jsxs(Ue,{style:{height:100},spinning:!0,children:["加载",u,"中..."]}),Yt=Lt(),re=10,hu=[{key:1,text:"OpenAI",value:1,color:"green",label:"OpenAI"},{key:2,text:"Midjourney Proxy",value:2,color:"light-blue",label:"Midjourney Proxy"},{key:5,text:"Midjourney Proxy Plus",value:5,color:"blue",label:"Midjourney Proxy Plus"},{key:4,text:"Ollama",value:4,color:"grey",label:"Ollama"},{key:14,text:"Anthropic Claude",value:14,color:"indigo",label:"Anthropic Claude"},{key:33,text:"AWS Claude",value:33,color:"indigo",label:"AWS Claude"},{key:3,text:"Azure OpenAI",value:3,color:"teal",label:"Azure OpenAI"},{key:11,text:"Google PaLM2",value:11,color:"orange",label:"Google PaLM2"},{key:24,text:"Google Gemini",value:24,color:"orange",label:"Google Gemini"},{key:34,text:"Cohere",value:34,color:"purple",label:"Cohere"},{key:15,text:"百度文心千帆",value:15,color:"blue",label:"百度文心千帆"},{key:17,text:"阿里通义千问",value:17,color:"orange",label:"阿里通义千问"},{key:18,text:"讯飞星火认知",value:18,color:"blue",label:"讯飞星火认知"},{key:16,text:"智谱 ChatGLM",value:16,color:"violet",label:"智谱 ChatGLM"},{key:16,text:"智谱 GLM-4V",value:26,color:"purple",label:"智谱 GLM-4V"},{key:16,text:"Moonshot",value:25,color:"green",label:"Moonshot"},{key:19,text:"360 智脑",value:19,color:"blue",label:"360 智脑"},{key:23,text:"腾讯混元",value:23,color:"teal",label:"腾讯混元"},{key:31,text:"零一万物",value:31,color:"green",label:"零一万物"},{key:8,text:"自定义渠道",value:8,color:"pink",label:"自定义渠道"},{key:22,text:"知识库：FastGPT",value:22,color:"blue",label:"知识库：FastGPT"},{key:21,text:"知识库：AI Proxy",value:21,color:"purple",label:"知识库：AI Proxy"}],Zt=({htmlContent:u})=>e.jsx("div",{dangerouslySetInnerHTML:{__html:u}});function be(){let u=localStorage.getItem("user");return u?(u=JSON.parse(u),u.role>=10):!1}function ut(){let u=localStorage.getItem("user");return u?(u=JSON.parse(u),u.role>=100):!1}function Eu(){let u=localStorage.getItem("system_name");return u||"New API"}function lu(){let u=localStorage.getItem("logo");return u||"/logo.png"}function Xt(){return localStorage.getItem("footer_html")}async function Re(u){let t=!0;try{await navigator.clipboard.writeText(u)}catch(a){t=!1,console.error(a)}return t}function Be(){return window.innerWidth<=600}let tt={autoClose:!1};Be()&&(tt.position="top-center");function m(u){if(console.error(u),u.message){if(u.name==="AxiosError"){switch(u.response.status){case 401:window.location.href="/login?expired=true";break;case 429:_e.error("错误：请求次数过多，请稍后再试！");break;case 500:_e.error("错误：服务器内部错误，请联系管理员！");break;case 405:_e.info("本站仅作演示之用，无服务端！");break;default:_e.error("错误："+u.message)}return}_e.error("错误："+u.message)}else _e.error("错误："+u)}function Y(u){_e.success(u)}function ye(u){_e.info(u)}function $u(u,t=!1){t?Ot(e.jsx(Zt,{htmlContent:u}),tt):_e.info(u)}function yu(u){return u.endsWith("/")?u.slice(0,-1):u}function we(u){let t=new Date(u*1e3),a=t.getFullYear().toString(),s=(t.getMonth()+1).toString(),i=t.getDate().toString(),l=t.getHours().toString(),c=t.getMinutes().toString(),f=t.getSeconds().toString();return s.length===1&&(s="0"+s),i.length===1&&(i="0"+i),l.length===1&&(l="0"+l),c.length===1&&(c="0"+c),f.length===1&&(f="0"+f),a+"-"+s+"-"+i+" "+l+":"+c+":"+f}function Cs(u,t="hour"){let a=new Date(u*1e3),s=(a.getMonth()+1).toString(),i=a.getDate().toString(),l=a.getHours().toString();s.length===1&&(s="0"+s),i.length===1&&(i="0"+i),l.length===1&&(l="0"+l);let c=s+"-"+i;if(t==="hour")c+=" "+l+":00";else if(t==="week"){let f=new Date(u*1e3+5184e5),R=(f.getMonth()+1).toString(),O=f.getDate().toString();R.length===1&&(R="0"+R),O.length===1&&(O="0"+O),c+=" - "+R+"-"+O}return c}function en(u,t){let a=new Blob([u],{type:"text/plain;charset=utf-8"}),s=URL.createObjectURL(a),i=document.createElement("a");i.href=s,i.download=t,i.click()}const Xe=u=>{try{JSON.parse(u)}catch{return!1}return!0};function un(u){return!localStorage.getItem(`prompt-${u}`)}var Ou={VITE_REACT_APP_VERSION:"",BASE_URL:"/",MODE:"production",DEV:!1,PROD:!0,SSR:!1};const k=$t.create({baseURL:Ou.VITE_REACT_APP_SERVER_URL?Ou.VITE_REACT_APP_SERVER_URL:""});k.interceptors.response.use(u=>u,u=>{m(u)});function nt(u){if(u==="")return e.jsx(S,{size:"large",children:"unknown"},"default");const t={vip:"yellow",pro:"yellow",svip:"red",premium:"red"},a=u.split(",").sort();return e.jsx("span",{children:a.map(s=>e.jsx(S,{size:"large",color:t[s]||tu(s),children:s},s))},u)}function pu(u){return u>=1e9?(u/1e9).toFixed(1)+"B":u>=1e6?(u/1e6).toFixed(1)+"M":u>=1e4?(u/1e3).toFixed(1)+"k":u}function js(u,t=2){let a=localStorage.getItem("display_in_currency");return u=u.toFixed(t),a?"$"+u:u}function tn(u){if(u=u.toFixed(2),u>=1e5){let t=u.toString(),a=t.indexOf("."),s=t,i="";return a!==-1&&(s=t.slice(0,a),i=t.slice(a)),s.slice(0,2)+".."+s.slice(-2)+i}return u}function du(){let u=localStorage.getItem("quota_per_unit");return u=parseFloat(u),u}function nn(u){let t=localStorage.getItem("quota_per_unit");return t=parseFloat(t),u=parseFloat(u),t*u}function fs(u,t=6){let a=localStorage.getItem("quota_per_unit");return a=parseFloat(a),(u/a).toFixed(t)}function sn(u){let t=localStorage.getItem("display_in_currency");return t=t==="true",t?"$"+u:nn(u)}function xe(u,t=2){let a=localStorage.getItem("quota_per_unit"),s=localStorage.getItem("display_in_currency");return a=parseFloat(a),s=s==="true",s?"$"+(u/a).toFixed(t):pu(u)}function uu(u,t){let a=localStorage.getItem("display_in_currency");return a=a==="true",a?`（等价金额：${xe(u,t)}）`:""}const zu=["amber","blue","cyan","green","grey","indigo","light-blue","lime","orange","pink","purple","red","teal","violet","yellow"],ys={"dall-e":"rgb(147,112,219)","dall-e-3":"rgb(153,50,204)","gpt-3.5-turbo":"rgb(184,227,167)","gpt-3.5-turbo-0613":"rgb(60,179,113)","gpt-3.5-turbo-1106":"rgb(32,178,170)","gpt-3.5-turbo-16k":"rgb(149,252,206)","gpt-3.5-turbo-16k-0613":"rgb(119,255,214)","gpt-3.5-turbo-instruct":"rgb(175,238,238)","gpt-4":"rgb(135,206,235)","gpt-4-0613":"rgb(100,149,237)","gpt-4-1106-preview":"rgb(30,144,255)","gpt-4-0125-preview":"rgb(2,177,236)","gpt-4-turbo-preview":"rgb(2,177,255)","gpt-4-32k":"rgb(104,111,238)","gpt-4-32k-0613":"rgb(61,71,139)","gpt-4-all":"rgb(65,105,225)","gpt-4-gizmo-*":"rgb(0,0,255)","gpt-4-vision-preview":"rgb(25,25,112)","text-ada-001":"rgb(255,192,203)","text-babbage-001":"rgb(255,160,122)","text-curie-001":"rgb(219,112,147)","text-davinci-003":"rgb(219,112,147)","text-davinci-edit-001":"rgb(255,105,180)","text-embedding-ada-002":"rgb(255,182,193)","text-embedding-v1":"rgb(255,174,185)","text-moderation-latest":"rgb(255,130,171)","text-moderation-stable":"rgb(255,160,122)","tts-1":"rgb(255,140,0)","tts-1-1106":"rgb(255,165,0)","tts-1-hd":"rgb(255,215,0)","tts-1-hd-1106":"rgb(255,223,0)","whisper-1":"rgb(245,245,220)","claude-3-opus-20240229":"rgb(255,132,31)","claude-3-sonnet-20240229":"rgb(253,135,93)","claude-3-haiku-20240307":"rgb(255,175,146)","claude-2.1":"rgb(255,209,190)"};function tu(u){let t=0;for(let s=0;s<u.length;s++)t+=u.charCodeAt(s);let a=t%zu.length;return zu[a]}const an=u=>{const t={username:"",display_name:"",password:""},[a,s]=n.useState(t),[i,l]=n.useState(!1),{username:c,display_name:f,password:R}=a,O=(_,w)=>{s(F=>({...F,[_]:w}))},L=async()=>{if(l(!0),a.username===""||a.password==="")return;const _=await k.post("/api/user/",a),{success:w,message:F}=_.data;w?(Y("用户账户创建成功！"),s(t),u.refresh(),u.handleClose()):m(F),l(!1)},j=()=>{u.handleClose()};return e.jsx(e.Fragment,{children:e.jsx(su,{placement:"left",title:e.jsx(Ge,{level:3,children:"添加用户"}),headerStyle:{borderBottom:"1px solid var(--semi-color-border)"},bodyStyle:{borderBottom:"1px solid var(--semi-color-border)"},visible:u.visible,footer:e.jsx("div",{style:{display:"flex",justifyContent:"flex-end"},children:e.jsxs(ie,{children:[e.jsx(v,{theme:"solid",size:"large",onClick:L,children:"提交"}),e.jsx(v,{theme:"solid",size:"large",type:"tertiary",onClick:j,children:"取消"})]})}),closeIcon:null,onCancel:()=>j(),width:Be()?"100%":600,children:e.jsxs(Ue,{spinning:i,children:[e.jsx(se,{style:{marginTop:20},label:"用户名",name:"username",addonBefore:"用户名",placeholder:"请输入用户名",onChange:_=>O("username",_),value:c,autoComplete:"off"}),e.jsx(se,{style:{marginTop:20},addonBefore:"显示名",label:"显示名称",name:"display_name",autoComplete:"off",placeholder:"请输入显示名称",onChange:_=>O("display_name",_),value:f}),e.jsx(se,{style:{marginTop:20},label:"密 码",name:"password",type:"password",addonBefore:"密码",placeholder:"请输入密码",onChange:_=>O("password",_),value:R,autoComplete:"off"})]})})})},Su=u=>{const t=u.editingUser.id,[a,s]=n.useState(!0),[i,l]=n.useState({username:"",display_name:"",password:"",github_id:"",wechat_id:"",email:"",quota:0,group:"default"}),[c,f]=n.useState([]),{username:R,display_name:O,password:L,github_id:j,wechat_id:_,telegram_id:w,email:F,quota:A,group:b}=i,h=(T,Q)=>{l(Z=>({...Z,[T]:Q}))},I=async()=>{try{let T=await k.get("/api/group/");f(T.data.data.map(Q=>({label:Q,value:Q})))}catch(T){m(T.message)}};Se();const $=()=>{u.handleClose()},H=async()=>{s(!0);let T;t?T=await k.get(`/api/user/${t}`):T=await k.get("/api/user/self");const{success:Q,message:Z,data:U}=T.data;Q?(U.password="",l(U)):m(Z),s(!1)};n.useEffect(()=>{H().then(),t&&I().then()},[u.editingUser.id]);const q=async()=>{s(!0);let T;if(t){let U={...i,id:parseInt(t)};typeof U.quota=="string"&&(U.quota=parseInt(U.quota)),T=await k.put("/api/user/",U)}else T=await k.put("/api/user/self",i);const{success:Q,message:Z}=T.data;Q?(Y("用户信息更新成功！"),u.refresh(),u.handleClose()):m(Z),s(!1)};return e.jsx(e.Fragment,{children:e.jsx(su,{placement:"right",title:e.jsx(Ge,{level:3,children:"编辑用户"}),headerStyle:{borderBottom:"1px solid var(--semi-color-border)"},bodyStyle:{borderBottom:"1px solid var(--semi-color-border)"},visible:u.visible,footer:e.jsx("div",{style:{display:"flex",justifyContent:"flex-end"},children:e.jsxs(ie,{children:[e.jsx(v,{theme:"solid",size:"large",onClick:q,children:"提交"}),e.jsx(v,{theme:"solid",size:"large",type:"tertiary",onClick:$,children:"取消"})]})}),closeIcon:null,onCancel:()=>$(),width:Be()?"100%":600,children:e.jsxs(Ue,{spinning:a,children:[e.jsx("div",{style:{marginTop:20},children:e.jsx(V.Text,{children:"用户名"})}),e.jsx(se,{label:"用户名",name:"username",placeholder:"请输入新的用户名",onChange:T=>h("username",T),value:R,autoComplete:"new-password"}),e.jsx("div",{style:{marginTop:20},children:e.jsx(V.Text,{children:"密码"})}),e.jsx(se,{label:"密码",name:"password",type:"password",placeholder:"请输入新的密码，最短 8 位",onChange:T=>h("password",T),value:L,autoComplete:"new-password"}),e.jsx("div",{style:{marginTop:20},children:e.jsx(V.Text,{children:"显示名称"})}),e.jsx(se,{label:"显示名称",name:"display_name",placeholder:"请输入新的显示名称",onChange:T=>h("display_name",T),value:O,autoComplete:"new-password"}),t&&e.jsxs(e.Fragment,{children:[e.jsx("div",{style:{marginTop:20},children:e.jsx(V.Text,{children:"分组"})}),e.jsx(Ae,{placeholder:"请选择分组",name:"group",fluid:!0,search:!0,selection:!0,allowAdditions:!0,additionLabel:"请在系统设置页面编辑分组倍率以添加新的分组：",onChange:T=>h("group",T),value:i.group,autoComplete:"new-password",optionList:c}),e.jsx("div",{style:{marginTop:20},children:e.jsx(V.Text,{children:`剩余额度${uu(A)}`})}),e.jsx(se,{name:"quota",placeholder:"请输入新的剩余额度",onChange:T=>h("quota",T),value:A,type:"number",autoComplete:"new-password"})]}),e.jsx(Fu,{style:{marginTop:20},children:"以下信息不可修改"}),e.jsx("div",{style:{marginTop:20},children:e.jsx(V.Text,{children:"已绑定的 GitHub 账户"})}),e.jsx(se,{name:"github_id",value:j,autoComplete:"new-password",placeholder:"此项只读，需要用户通过个人设置页面的相关绑定按钮进行绑定，不可直接修改",readonly:!0}),e.jsx("div",{style:{marginTop:20},children:e.jsx(V.Text,{children:"已绑定的微信账户"})}),e.jsx(se,{name:"wechat_id",value:_,autoComplete:"new-password",placeholder:"此项只读，需要用户通过个人设置页面的相关绑定按钮进行绑定，不可直接修改",readonly:!0}),e.jsx("div",{style:{marginTop:20},children:e.jsx(V.Text,{children:"已绑定的邮箱账户"})}),e.jsx(se,{name:"email",value:F,autoComplete:"new-password",placeholder:"此项只读，需要用户通过个人设置页面的相关绑定按钮进行绑定，不可直接修改",readonly:!0}),e.jsx("div",{style:{marginTop:20},children:e.jsx(V.Text,{children:"已绑定的Telegram账户"})}),e.jsx(se,{name:"telegram_id",value:w,autoComplete:"new-password",placeholder:"此项只读，需要用户通过个人设置页面的相关绑定按钮进行绑定，不可直接修改",readonly:!0})]})})})};function ln(u){switch(u){case 1:return e.jsx(S,{size:"large",children:"普通用户"});case 10:return e.jsx(S,{color:"yellow",size:"large",children:"管理员"});case 100:return e.jsx(S,{color:"orange",size:"large",children:"超级管理员"});default:return e.jsx(S,{color:"red",size:"large",children:"未知身份"})}}const rn=()=>{const u=[{title:"ID",dataIndex:"id"},{title:"用户名",dataIndex:"username"},{title:"分组",dataIndex:"group",render:(o,B,E)=>e.jsx("div",{children:nt(o)})},{title:"统计信息",dataIndex:"info",render:(o,B,E)=>e.jsx("div",{children:e.jsxs(ie,{spacing:1,children:[e.jsx(Le,{content:"剩余额度",children:e.jsx(S,{color:"white",size:"large",children:xe(B.quota)})}),e.jsx(Le,{content:"已用额度",children:e.jsx(S,{color:"white",size:"large",children:xe(B.used_quota)})}),e.jsx(Le,{content:"调用次数",children:e.jsx(S,{color:"white",size:"large",children:pu(B.request_count)})})]})})},{title:"邀请信息",dataIndex:"invite",render:(o,B,E)=>e.jsx("div",{children:e.jsxs(ie,{spacing:1,children:[e.jsx(Le,{content:"邀请人数",children:e.jsx(S,{color:"white",size:"large",children:pu(B.aff_count)})}),e.jsx(Le,{content:"邀请总收益",children:e.jsx(S,{color:"white",size:"large",children:xe(B.aff_history_quota)})}),e.jsx(Le,{content:"邀请人ID",children:B.inviter_id===0?e.jsx(S,{color:"white",size:"large",children:"无"}):e.jsx(S,{color:"white",size:"large",children:B.inviter_id})})]})})},{title:"角色",dataIndex:"role",render:(o,B,E)=>e.jsx("div",{children:ln(o)})},{title:"状态",dataIndex:"status",render:(o,B,E)=>e.jsx("div",{children:B.DeletedAt!==null?e.jsx(S,{color:"red",children:"已注销"}):x(o)})},{title:"",dataIndex:"operate",render:(o,B,E)=>e.jsxs("div",{children:[B.DeletedAt!==null?e.jsx(e.Fragment,{}):e.jsxs(e.Fragment,{children:[e.jsx(De,{title:"确定？",okType:"warning",onConfirm:()=>{M(B.username,"promote",B)},children:e.jsx(v,{theme:"light",type:"warning",style:{marginRight:1},children:"提升"})}),e.jsx(De,{title:"确定？",okType:"warning",onConfirm:()=>{M(B.username,"demote",B)},children:e.jsx(v,{theme:"light",type:"secondary",style:{marginRight:1},children:"降级"})}),B.status===1?e.jsx(v,{theme:"light",type:"warning",style:{marginRight:1},onClick:async()=>{M(B.username,"disable",B)},children:"禁用"}):e.jsx(v,{theme:"light",type:"secondary",style:{marginRight:1},onClick:async()=>{M(B.username,"enable",B)},disabled:B.status===3,children:"启用"}),e.jsx(v,{theme:"light",type:"tertiary",style:{marginRight:1},onClick:()=>{T(B),H(!0)},children:"编辑"})]}),e.jsx(De,{title:"确定是否要删除此用户？",content:"硬删除，此修改将不可逆",okType:"danger",position:"left",onConfirm:()=>{M(B.username,"delete",B).then(()=>{Z(B.id)})},children:e.jsx(v,{theme:"light",type:"danger",style:{marginRight:1},children:"删除"})})]})}],[t,a]=n.useState([]),[s,i]=n.useState(!0),[l,c]=n.useState(1),[f,R]=n.useState(""),[O,L]=n.useState(!1),[j,_]=n.useState(""),[w,F]=n.useState([]),[A,b]=n.useState(re),[h,I]=n.useState(!1),[$,H]=n.useState(!1),[q,T]=n.useState({id:void 0}),Q=o=>{o.length>=l*re?b(o.length+1):b(o.length)},Z=o=>{console.log(o);let B=[...t];if(o!=null){let E=B.findIndex(z=>z.id===o);E>-1&&(B.splice(E,1),a(B))}},U=async o=>{const B=await k.get(`/api/user/?p=${o}`),{success:E,message:z,data:te}=B.data;if(E)if(o===0)a(te),Q(te);else{let p=t;p.push(...te),a(p),Q(p)}else m(z);i(!1)};n.useEffect(()=>{U(0).then().catch(o=>{m(o)}),ue().then()},[]);const M=async(o,B,E)=>{const z=await k.post("/api/user/manage",{username:o,action:B}),{success:te,message:p}=z.data;if(te){Y("操作成功完成！");let N=z.data.data,ne=[...t];B==="delete"||(E.status=N.status,E.role=N.role),a(ne)}else m(p)},x=o=>{switch(o){case 1:return e.jsx(S,{size:"large",children:"已激活"});case 2:return e.jsx(S,{size:"large",color:"red",children:"已封禁"});default:return e.jsx(S,{size:"large",color:"grey",children:"未知状态"})}},K=async(o,B)=>{if(o===""&&B===""){await U(0),c(1);return}L(!0);const E=await k.get(`/api/user/search?keyword=${o}&group=${B}`),{success:z,message:te,data:p}=E.data;z?(a(p),c(1)):m(te),L(!1)},W=async o=>{R(o.trim())},P=o=>{c(o),o===Math.ceil(t.length/re)+1&&U(o-1).then(B=>{})},r=t.slice((l-1)*re,l*re),y=()=>{I(!1)},g=()=>{H(!1),T({id:void 0})},J=async()=>{f===""?await U(l-1):await K()},ue=async()=>{try{let o=await k.get("/api/group/");if(o===void 0)return;F(o.data.data.map(B=>({label:B,value:B})))}catch(o){m(o.message)}};return e.jsxs(e.Fragment,{children:[e.jsx(an,{refresh:J,visible:h,handleClose:y}),e.jsx(Su,{refresh:J,visible:$,handleClose:g,editingUser:q}),e.jsx(ee,{onSubmit:()=>{K(f,j)},labelPosition:"left",children:e.jsx("div",{style:{display:"flex"},children:e.jsxs(ie,{children:[e.jsx(ee.Input,{label:"搜索关键字",icon:"search",field:"keyword",iconPosition:"left",placeholder:"搜索用户的 ID，用户名，显示名称，以及邮箱地址 ...",value:f,loading:O,onChange:o=>W(o)}),e.jsx(ee.Select,{field:"group",label:"分组",optionList:w,onChange:o=>{_(o),K(f,o)}}),e.jsx(v,{label:"查询",type:"primary",htmlType:"submit",className:"btn-margin-right",style:{marginRight:8},children:"查询"})]})})}),e.jsx(Je,{columns:u,dataSource:r,pagination:{currentPage:l,pageSize:re,total:A,pageSizeOpts:[10,20,50,100],onPageChange:P},loading:s}),e.jsx(v,{theme:"light",type:"primary",style:{marginRight:8},onClick:()=>{I(!0)},children:"添加用户"})]})},on=()=>e.jsx(e.Fragment,{children:e.jsxs(le,{children:[e.jsx(le.Header,{children:e.jsx("h3",{children:"管理用户"})}),e.jsx(le.Content,{children:e.jsx(rn,{})})]})});function Pe({children:u}){return localStorage.getItem("user")?u:e.jsx(ht,{to:"/login",state:{from:Yt.location}})}const cn=()=>{const[u,t]=n.useState({username:"",password:"",password2:"",email:"",verification_code:""}),{username:a,password:s,password2:i}=u,[l,c]=n.useState(!1),[f,R]=n.useState(!1),[O,L]=n.useState(""),[j,_]=n.useState(""),[w,F]=n.useState(!1),A=lu();let b=new URLSearchParams(window.location.search).get("aff");b&&localStorage.setItem("aff",b),n.useEffect(()=>{let q=localStorage.getItem("status");q&&(q=JSON.parse(q),c(q.email_verification),q.turnstile_check&&(R(!0),L(q.turnstile_site_key)))});let h=Se();function I(q){const{name:T,value:Q}=q.target;console.log(T,Q),t(Z=>({...Z,[T]:Q}))}async function $(q){if(s.length<8){ye("密码长度不得小于 8 位！");return}if(s!==i){ye("两次输入的密码不一致");return}if(a&&s){if(f&&j===""){ye("请稍后几秒重试，Turnstile 正在检查用户环境！");return}F(!0),b||(b=localStorage.getItem("aff")),u.aff_code=b;const T=await k.post(`/api/user/register?turnstile=${j}`,u),{success:Q,message:Z}=T.data;Q?(h("/login"),Y("注册成功！")):m(Z),F(!1)}}const H=async()=>{if(u.email==="")return;if(f&&j===""){ye("请稍后几秒重试，Turnstile 正在检查用户环境！");return}F(!0);const q=await k.get(`/api/verification?email=${u.email}&turnstile=${j}`),{success:T,message:Q}=q.data;T?Y("验证码发送成功，请检查你的邮箱！"):m(Q),F(!1)};return e.jsx(Te,{textAlign:"center",style:{marginTop:"48px"},children:e.jsxs(Te.Column,{style:{maxWidth:450},children:[e.jsxs(ce,{as:"h2",color:"",textAlign:"center",children:[e.jsx(Tu,{src:A})," 新用户注册"]}),e.jsx(d,{size:"large",children:e.jsxs(gu,{children:[e.jsx(d.Input,{fluid:!0,icon:"user",iconPosition:"left",placeholder:"输入用户名，最长 12 位",onChange:I,name:"username"}),e.jsx(d.Input,{fluid:!0,icon:"lock",iconPosition:"left",placeholder:"输入密码，最短 8 位，最长 20 位",onChange:I,name:"password",type:"password"}),e.jsx(d.Input,{fluid:!0,icon:"lock",iconPosition:"left",placeholder:"输入密码，最短 8 位，最长 20 位",onChange:I,name:"password2",type:"password"}),l?e.jsxs(e.Fragment,{children:[e.jsx(d.Input,{fluid:!0,icon:"mail",iconPosition:"left",placeholder:"输入邮箱地址",onChange:I,name:"email",type:"email",action:e.jsx(Ne,{onClick:H,disabled:w,children:"获取验证码"})}),e.jsx(d.Input,{fluid:!0,icon:"lock",iconPosition:"left",placeholder:"输入验证码",onChange:I,name:"verification_code"})]}):e.jsx(e.Fragment,{}),f?e.jsx(Qe,{sitekey:O,onVerify:q=>{_(q)}}):e.jsx(e.Fragment,{}),e.jsx(Ne,{color:"green",fluid:!0,size:"large",onClick:$,loading:w,children:"注册"})]})}),e.jsxs(mu,{children:["已有账户？",e.jsx(eu,{to:"/login",className:"btn btn-link",children:"点击登录"})]})]})})},dn=(u,t)=>{switch(t.type){case"login":return{...u,user:t.payload};case"logout":return{...u,user:void 0};default:return u}},st={user:void 0},We=nu.createContext({state:st,dispatch:()=>null}),hn=({children:u})=>{const[t,a]=nu.useReducer(dn,st);return e.jsx(We.Provider,{value:[t,a],children:u})};async function Fn(){const u=await k.get("/api/oauth/state"),{success:t,message:a,data:s}=u.data;return t?s:(m(a),"")}async function at(u){const t=await Fn();t&&window.open(`https://github.com/login/oauth/authorize?client_id=${u}&state=${t}&scope=user:email`)}const mn=()=>{function u(){return e.jsxs("svg",{t:"1709714447384",className:"icon",viewBox:"0 0 1024 1024",version:"1.1",xmlns:"http://www.w3.org/2000/svg","p-id":"5091",width:"16",height:"16",children:[e.jsx("path",{d:"M690.1 377.4c5.9 0 11.8 0.2 17.6 0.5-24.4-128.7-158.3-227.1-319.9-227.1C209 150.8 64 271.4 64 420.2c0 81.1 43.6 154.2 111.9 203.6 5.5 3.9 9.1 10.3 9.1 17.6 0 2.4-0.5 4.6-1.1 6.9-5.5 20.3-14.2 52.8-14.6 54.3-0.7 2.6-1.7 5.2-1.7 7.9 0 5.9 4.8 10.8 10.8 10.8 2.3 0 4.2-0.9 6.2-2l70.9-40.9c5.3-3.1 11-5 17.2-5 3.2 0 6.4 0.5 9.5 1.4 33.1 9.5 68.8 14.8 105.7 14.8 6 0 11.9-0.1 17.8-0.4-7.1-21-10.9-43.1-10.9-66 0-135.8 132.2-245.8 295.3-245.8z m-194.3-86.5c23.8 0 43.2 19.3 43.2 43.1s-19.3 43.1-43.2 43.1c-23.8 0-43.2-19.3-43.2-43.1s19.4-43.1 43.2-43.1z m-215.9 86.2c-23.8 0-43.2-19.3-43.2-43.1s19.3-43.1 43.2-43.1 43.2 19.3 43.2 43.1-19.4 43.1-43.2 43.1z","p-id":"5092"}),e.jsx("path",{d:"M866.7 792.7c56.9-41.2 93.2-102 93.2-169.7 0-124-120.8-224.5-269.9-224.5-149 0-269.9 100.5-269.9 224.5S540.9 847.5 690 847.5c30.8 0 60.6-4.4 88.1-12.3 2.6-0.8 5.2-1.2 7.9-1.2 5.2 0 9.9 1.6 14.3 4.1l59.1 34c1.7 1 3.3 1.7 5.2 1.7 2.4 0 4.7-0.9 6.4-2.6 1.7-1.7 2.6-4 2.6-6.4 0-2.2-0.9-4.4-1.4-6.6-0.3-1.2-7.6-28.3-12.2-45.3-0.5-1.9-0.9-3.8-0.9-5.7 0.1-5.9 3.1-11.2 7.6-14.5zM600.2 587.2c-19.9 0-36-16.1-36-35.9 0-19.8 16.1-35.9 36-35.9s36 16.1 36 35.9c0 19.8-16.2 35.9-36 35.9z m179.9 0c-19.9 0-36-16.1-36-35.9 0-19.8 16.1-35.9 36-35.9s36 16.1 36 35.9c-0.1 19.8-16.2 35.9-36 35.9z","p-id":"5093"})]})}return e.jsx("div",{children:e.jsx(Hu,{svg:e.jsx(u,{})})})},pn=()=>{const[u,t]=n.useState({username:"",password:"",wechat_verification_code:""}),[a,s]=ku(),[i,l]=n.useState(!1),{username:c,password:f}=u,[R,O]=n.useContext(We),[L,j]=n.useState(!1),[_,w]=n.useState(""),[F,A]=n.useState("");let b=Se();const[h,I]=n.useState({});lu(),n.useEffect(()=>{a.get("expired")&&m("未登录或登录已过期，请重新登录！");let M=localStorage.getItem("status");M&&(M=JSON.parse(M),I(M),M.turnstile_check&&(j(!0),w(M.turnstile_site_key)))},[]);const[$,H]=n.useState(!1),q=()=>{H(!0)},T=async()=>{if(L&&F===""){ye("请稍后几秒重试，Turnstile 正在检查用户环境！");return}const M=await k.get(`/api/oauth/wechat?code=${u.wechat_verification_code}`),{success:x,message:K,data:W}=M.data;x?(O({type:"login",payload:W}),localStorage.setItem("user",JSON.stringify(W)),b("/"),Y("登录成功！"),H(!1)):m(K)};function Q(M,x){t(K=>({...K,[M]:x}))}async function Z(M){if(L&&F===""){ye("请稍后几秒重试，Turnstile 正在检查用户环境！");return}if(l(!0),c&&f){const x=await k.post(`/api/user/login?turnstile=${F}`,{username:c,password:f}),{success:K,message:W,data:P}=x.data;K?(O({type:"login",payload:P}),localStorage.setItem("user",JSON.stringify(P)),Y("登录成功！"),c==="root"&&f==="123456"&&je.error({title:"您正在使用默认密码！",content:"请立刻修改默认密码！",centered:!0}),b("/token")):m(W)}else m("请输入用户名和密码！")}const U=async M=>{const x=["id","first_name","last_name","username","photo_url","auth_date","hash","lang"],K={};x.forEach(g=>{M[g]&&(K[g]=M[g])});const W=await k.get("/api/oauth/telegram/login",{params:K}),{success:P,message:r,data:y}=W.data;P?(O({type:"login",payload:y}),localStorage.setItem("user",JSON.stringify(y)),Y("登录成功！"),b("/")):m(r)};return e.jsx("div",{children:e.jsxs(le,{children:[e.jsx(le.Header,{}),e.jsx(le.Content,{children:e.jsx("div",{style:{justifyContent:"center",display:"flex",marginTop:120},children:e.jsxs("div",{style:{width:500},children:[e.jsxs(qe,{children:[e.jsx(Ge,{heading:2,style:{textAlign:"center"},children:"用户登录"}),e.jsxs(ee,{children:[e.jsx(ee.Input,{field:"username",label:"用户名",placeholder:"用户名",name:"username",onChange:M=>Q("username",M)}),e.jsx(ee.Input,{field:"password",label:"密码",placeholder:"密码",name:"password",type:"password",onChange:M=>Q("password",M)}),e.jsx(v,{theme:"solid",style:{width:"100%"},type:"primary",size:"large",htmlType:"submit",onClick:Z,children:"登录"})]}),e.jsxs("div",{style:{display:"flex",justifyContent:"space-between",marginTop:20},children:[e.jsxs(Ru,{children:["没有账号请先 ",e.jsx(eu,{to:"/register",children:"注册账号"})]}),e.jsxs(Ru,{children:["忘记密码 ",e.jsx(eu,{to:"/reset",children:"点击重置"})]})]}),h.github_oauth||h.wechat_login||h.telegram_oauth?e.jsxs(e.Fragment,{children:[e.jsx(Fu,{margin:"12px",align:"center",children:"第三方登录"}),e.jsxs("div",{style:{display:"flex",justifyContent:"center",marginTop:20},children:[h.github_oauth?e.jsx(v,{type:"primary",icon:e.jsx(xt,{}),onClick:()=>at(h.github_client_id)}):e.jsx(e.Fragment,{}),h.wechat_login?e.jsx(v,{type:"primary",style:{color:"rgba(var(--semi-green-5), 1)"},icon:e.jsx(Hu,{svg:e.jsx(mn,{})}),onClick:q}):e.jsx(e.Fragment,{})]}),h.telegram_oauth?e.jsx(e.Fragment,{children:e.jsx("div",{style:{display:"flex",justifyContent:"center",marginTop:5},children:e.jsx(Zu,{dataOnauth:U,botName:h.telegram_bot_name})})}):e.jsx(e.Fragment,{})]}):e.jsx(e.Fragment,{}),e.jsxs(je,{title:"微信扫码登录",visible:$,maskClosable:!0,onOk:T,onCancel:()=>H(!1),okText:"登录",size:"small",centered:!0,children:[e.jsx("div",{style:{display:"flex",alignItem:"center",flexDirection:"column"},children:e.jsx("img",{src:h.wechat_qrcode})}),e.jsx("div",{style:{textAlign:"center"},children:e.jsx("p",{children:"微信扫码关注公众号，输入「验证码」获取验证码（三分钟内有效）"})}),e.jsx(ee,{size:"large",children:e.jsx(ee.Input,{field:"wechat_verification_code",placeholder:"验证码",label:"验证码",value:u.wechat_verification_code,onChange:M=>Q("wechat_verification_code",M)})})]})]}),L?e.jsx("div",{style:{display:"flex",justifyContent:"center",marginTop:20},children:e.jsx(Qe,{sitekey:_,onVerify:M=>{A(M)}})}):e.jsx(e.Fragment,{})]})})})]})})},gn=()=>e.jsx(e.Fragment,{children:e.jsxs(mu,{negative:!0,children:[e.jsx(mu.Header,{children:"页面不存在"}),e.jsx("p",{children:"请检查你的浏览器地址是否正确"})]})}),lt=n.createContext(null),Pu=()=>n.useContext(lt),it=n.createContext(null),xn=()=>n.useContext(it),En=({children:u})=>{const[t,a]=n.useState(()=>{try{return localStorage.getItem("theme-mode")||null}catch{return null}}),s=n.useCallback(i=>{a(i?"dark":"light");const l=document.body;i?(l.setAttribute("theme-mode","dark"),localStorage.setItem("theme-mode","dark")):(l.removeAttribute("theme-mode"),localStorage.setItem("theme-mode","light"))},[]);return e.jsx(it.Provider,{value:s,children:e.jsx(lt.Provider,{value:t,children:u})})},Cn=()=>{let[u,t]=n.useState({PasswordLoginEnabled:"",PasswordRegisterEnabled:"",EmailVerificationEnabled:"",GitHubOAuthEnabled:"",GitHubClientId:"",GitHubClientSecret:"",Notice:"",SMTPServer:"",SMTPPort:"",SMTPAccount:"",SMTPFrom:"",SMTPToken:"",ServerAddress:"",EpayId:"",EpayKey:"",Price:7.3,MinTopUp:1,TopupGroupRatio:"",PayAddress:"",CustomCallbackAddress:"",Footer:"",WeChatAuthEnabled:"",WeChatServerAddress:"",WeChatServerToken:"",WeChatAccountQRCodeImageURL:"",TurnstileCheckEnabled:"",TurnstileSiteKey:"",TurnstileSecretKey:"",RegisterEnabled:"",EmailDomainRestrictionEnabled:"",EmailAliasRestrictionEnabled:"",SMTPSSLEnabled:"",EmailDomainWhitelist:[],TelegramOAuthEnabled:"",TelegramBotToken:"",TelegramBotName:""});const[a,s]=n.useState({});let[i,l]=n.useState(!1);const[c,f]=n.useState([]),[R,O]=n.useState(""),[L,j]=n.useState(!1),w=Pu()==="dark",F=async()=>{const M=await k.get("/api/option/"),{success:x,message:K,data:W}=M.data;if(x){let P={};W.forEach(r=>{r.key==="TopupGroupRatio"&&(r.value=JSON.stringify(JSON.parse(r.value),null,2)),P[r.key]=r.value}),t({...P,EmailDomainWhitelist:P.EmailDomainWhitelist.split(",")}),s(P),f(P.EmailDomainWhitelist.split(",").map(r=>({key:r,text:r,value:r})))}else m(K)};n.useEffect(()=>{F().then()},[]),n.useEffect(()=>{},[u.EmailDomainWhitelist]);const A=async(M,x)=>{switch(l(!0),M){case"PasswordLoginEnabled":case"PasswordRegisterEnabled":case"EmailVerificationEnabled":case"GitHubOAuthEnabled":case"WeChatAuthEnabled":case"TelegramOAuthEnabled":case"TurnstileCheckEnabled":case"EmailDomainRestrictionEnabled":case"EmailAliasRestrictionEnabled":case"SMTPSSLEnabled":case"RegisterEnabled":x=u[M]==="true"?"false":"true";break}const K=await k.put("/api/option/",{key:M,value:x}),{success:W,message:P}=K.data;W?(M==="EmailDomainWhitelist"&&(x=x.split(",")),M==="Price"&&(x=parseFloat(x)),t(r=>({...r,[M]:x}))):m(P),l(!1)},b=async(M,{name:x,value:K})=>{if(x==="PasswordLoginEnabled"&&u[x]==="true"){j(!0);return}x==="Notice"||x.startsWith("SMTP")&&x!=="SMTPSSLEnabled"||x==="ServerAddress"||x==="EpayId"||x==="EpayKey"||x==="Price"||x==="PayAddress"||x==="GitHubClientId"||x==="GitHubClientSecret"||x==="WeChatServerAddress"||x==="WeChatServerToken"||x==="WeChatAccountQRCodeImageURL"||x==="TurnstileSiteKey"||x==="TurnstileSecretKey"||x==="EmailDomainWhitelist"||x==="TopupGroupRatio"||x==="TelegramBotToken"||x==="TelegramBotName"?t(W=>({...W,[x]:K})):await A(x,K)},h=async()=>{let M=yu(u.ServerAddress);await A("ServerAddress",M)},I=async()=>{if(u.ServerAddress===""){m("请先填写服务器地址");return}if(a.TopupGroupRatio!==u.TopupGroupRatio){if(!Xe(u.TopupGroupRatio)){m("充值分组倍率不是合法的 JSON 字符串");return}await A("TopupGroupRatio",u.TopupGroupRatio)}let M=yu(u.PayAddress);await A("PayAddress",M),u.EpayId!==""&&await A("EpayId",u.EpayId),u.EpayKey!==void 0&&u.EpayKey!==""&&await A("EpayKey",u.EpayKey),await A("Price",""+u.Price)},$=async()=>{a.SMTPServer!==u.SMTPServer&&await A("SMTPServer",u.SMTPServer),a.SMTPAccount!==u.SMTPAccount&&await A("SMTPAccount",u.SMTPAccount),a.SMTPFrom!==u.SMTPFrom&&await A("SMTPFrom",u.SMTPFrom),a.SMTPPort!==u.SMTPPort&&u.SMTPPort!==""&&await A("SMTPPort",u.SMTPPort),a.SMTPToken!==u.SMTPToken&&u.SMTPToken!==""&&await A("SMTPToken",u.SMTPToken)},H=async()=>{a.EmailDomainWhitelist!==u.EmailDomainWhitelist.join(",")&&u.SMTPToken!==""&&await A("EmailDomainWhitelist",u.EmailDomainWhitelist.join(","))},q=async()=>{a.WeChatServerAddress!==u.WeChatServerAddress&&await A("WeChatServerAddress",yu(u.WeChatServerAddress)),a.WeChatAccountQRCodeImageURL!==u.WeChatAccountQRCodeImageURL&&await A("WeChatAccountQRCodeImageURL",u.WeChatAccountQRCodeImageURL),a.WeChatServerToken!==u.WeChatServerToken&&u.WeChatServerToken!==""&&await A("WeChatServerToken",u.WeChatServerToken)},T=async()=>{a.GitHubClientId!==u.GitHubClientId&&await A("GitHubClientId",u.GitHubClientId),a.GitHubClientSecret!==u.GitHubClientSecret&&u.GitHubClientSecret!==""&&await A("GitHubClientSecret",u.GitHubClientSecret)},Q=async()=>{await A("TelegramBotToken",u.TelegramBotToken),await A("TelegramBotName",u.TelegramBotName)},Z=async()=>{a.TurnstileSiteKey!==u.TurnstileSiteKey&&await A("TurnstileSiteKey",u.TurnstileSiteKey),a.TurnstileSecretKey!==u.TurnstileSecretKey&&u.TurnstileSecretKey!==""&&await A("TurnstileSecretKey",u.TurnstileSecretKey)},U=()=>{const M=u.EmailDomainWhitelist;R!==""&&!M.includes(R)&&(O(""),t({...u,EmailDomainWhitelist:[...M,R]}),f([...c,{key:R,text:R,value:R}]))};return e.jsx(Te,{columns:1,children:e.jsx(Te.Column,{children:e.jsxs(d,{loading:i,inverted:w,children:[e.jsx(ce,{as:"h3",inverted:w,children:"通用设置"}),e.jsx(d.Group,{widths:"equal",children:e.jsx(d.Input,{label:"服务器地址",placeholder:"例如：https://yourdomain.com",value:u.ServerAddress,name:"ServerAddress",onChange:b})}),e.jsx(d.Button,{onClick:h,children:"更新服务器地址"}),e.jsx(ge,{}),e.jsx(ce,{as:"h3",inverted:w,children:"支付设置（当前仅支持易支付接口，默认使用上方服务器地址作为回调地址！）"}),e.jsxs(d.Group,{widths:"equal",children:[e.jsx(d.Input,{label:"支付地址，不填写则不启用在线支付",placeholder:"例如：https://yourdomain.com",value:u.PayAddress,name:"PayAddress",onChange:b}),e.jsx(d.Input,{label:"易支付商户ID",placeholder:"例如：0001",value:u.EpayId,name:"EpayId",onChange:b}),e.jsx(d.Input,{label:"易支付商户密钥",placeholder:"敏感信息不会发送到前端显示",value:u.EpayKey,name:"EpayKey",onChange:b})]}),e.jsxs(d.Group,{widths:"equal",children:[e.jsx(d.Input,{label:"回调地址，不填写则使用上方服务器地址作为回调地址",placeholder:"例如：https://yourdomain.com",value:u.CustomCallbackAddress,name:"CustomCallbackAddress",onChange:b}),e.jsx(d.Input,{label:"充值价格（x元/美金）",placeholder:"例如：7，就是7元/美金",value:u.Price,name:"Price",min:0,onChange:b}),e.jsx(d.Input,{label:"最低充值美元数量（以美金为单位，如果使用额度请自行换算！）",placeholder:"例如：2，就是最低充值2$",value:u.MinTopUp,name:"MinTopUp",min:1,onChange:b})]}),e.jsx(d.Group,{widths:"equal",children:e.jsx(d.TextArea,{label:"充值分组倍率",name:"TopupGroupRatio",onChange:b,style:{minHeight:250,fontFamily:"JetBrains Mono, Consolas"},autoComplete:"new-password",value:u.TopupGroupRatio,placeholder:"为一个 JSON 文本，键为组名称，值为倍率"})}),e.jsx(d.Button,{onClick:I,children:"更新支付设置"}),e.jsx(ge,{}),e.jsx(ce,{as:"h3",inverted:w,children:"配置登录注册"}),e.jsxs(d.Group,{inline:!0,children:[e.jsx(d.Checkbox,{checked:u.PasswordLoginEnabled==="true",label:"允许通过密码进行登录",name:"PasswordLoginEnabled",onChange:b}),L&&e.jsxs(cu,{open:L,onClose:()=>j(!1),size:"tiny",style:{maxWidth:"450px"},children:[e.jsx(cu.Header,{children:"警告"}),e.jsx(cu.Content,{children:e.jsx("p",{children:"取消密码登录将导致所有未绑定其他登录方式的用户（包括管理员）无法通过密码登录，确认取消？"})}),e.jsxs(cu.Actions,{children:[e.jsx(Ne,{onClick:()=>j(!1),children:"取消"}),e.jsx(Ne,{color:"yellow",onClick:async()=>{j(!1),await A("PasswordLoginEnabled","false")},children:"确定"})]})]}),e.jsx(d.Checkbox,{checked:u.PasswordRegisterEnabled==="true",label:"允许通过密码进行注册",name:"PasswordRegisterEnabled",onChange:b}),e.jsx(d.Checkbox,{checked:u.EmailVerificationEnabled==="true",label:"通过密码注册时需要进行邮箱验证",name:"EmailVerificationEnabled",onChange:b}),e.jsx(d.Checkbox,{checked:u.GitHubOAuthEnabled==="true",label:"允许通过 GitHub 账户登录 & 注册",name:"GitHubOAuthEnabled",onChange:b}),e.jsx(d.Checkbox,{checked:u.WeChatAuthEnabled==="true",label:"允许通过微信登录 & 注册",name:"WeChatAuthEnabled",onChange:b}),e.jsx(d.Checkbox,{checked:u.TelegramOAuthEnabled==="true",label:"允许通过 Telegram 进行登录",name:"TelegramOAuthEnabled",onChange:b})]}),e.jsxs(d.Group,{inline:!0,children:[e.jsx(d.Checkbox,{checked:u.RegisterEnabled==="true",label:"允许新用户注册（此项为否时，新用户将无法以任何方式进行注册）",name:"RegisterEnabled",onChange:b}),e.jsx(d.Checkbox,{checked:u.TurnstileCheckEnabled==="true",label:"启用 Turnstile 用户校验",name:"TurnstileCheckEnabled",onChange:b})]}),e.jsx(ge,{}),e.jsxs(ce,{as:"h3",inverted:w,children:["配置邮箱域名白名单",e.jsx(ce.Subheader,{children:"用以防止恶意用户利用临时邮箱批量注册"})]}),e.jsx(d.Group,{widths:3,children:e.jsx(d.Checkbox,{label:"启用邮箱域名白名单",name:"EmailDomainRestrictionEnabled",onChange:b,checked:u.EmailDomainRestrictionEnabled==="true"})}),e.jsx(d.Group,{widths:3,children:e.jsx(d.Checkbox,{label:"启用邮箱别名限制（例如：ab.cd@gmail.com）",name:"EmailAliasRestrictionEnabled",onChange:b,checked:u.EmailAliasRestrictionEnabled==="true"})}),e.jsxs(d.Group,{widths:2,children:[e.jsx(d.Dropdown,{label:"允许的邮箱域名",placeholder:"允许的邮箱域名",name:"EmailDomainWhitelist",required:!0,fluid:!0,multiple:!0,selection:!0,onChange:b,value:u.EmailDomainWhitelist,autoComplete:"new-password",options:c}),e.jsx(d.Input,{label:"添加新的允许的邮箱域名",action:e.jsx(Ne,{type:"button",onClick:()=>{U()},children:"填入"}),onKeyDown:M=>{M.key==="Enter"&&U()},autoComplete:"new-password",placeholder:"输入新的允许的邮箱域名",value:R,onChange:(M,{value:x})=>{O(x)}})]}),e.jsx(d.Button,{onClick:H,children:"保存邮箱域名白名单设置"}),e.jsx(ge,{}),e.jsxs(ce,{as:"h3",inverted:w,children:["配置 SMTP",e.jsx(ce.Subheader,{children:"用以支持系统的邮件发送"})]}),e.jsxs(d.Group,{widths:3,children:[e.jsx(d.Input,{label:"SMTP 服务器地址",name:"SMTPServer",onChange:b,autoComplete:"new-password",value:u.SMTPServer,placeholder:"例如：smtp.qq.com"}),e.jsx(d.Input,{label:"SMTP 端口",name:"SMTPPort",onChange:b,autoComplete:"new-password",value:u.SMTPPort,placeholder:"默认: 587"}),e.jsx(d.Input,{label:"SMTP 账户",name:"SMTPAccount",onChange:b,autoComplete:"new-password",value:u.SMTPAccount,placeholder:"通常是邮箱地址"})]}),e.jsxs(d.Group,{widths:3,children:[e.jsx(d.Input,{label:"SMTP 发送者邮箱",name:"SMTPFrom",onChange:b,autoComplete:"new-password",value:u.SMTPFrom,placeholder:"通常和邮箱地址保持一致"}),e.jsx(d.Input,{label:"SMTP 访问凭证",name:"SMTPToken",onChange:b,type:"password",autoComplete:"new-password",checked:u.RegisterEnabled==="true",placeholder:"敏感信息不会发送到前端显示"})]}),e.jsx(d.Group,{widths:3,children:e.jsx(d.Checkbox,{label:"启用SMTP SSL（465端口强制开启）",name:"SMTPSSLEnabled",onChange:b,checked:u.SMTPSSLEnabled==="true"})}),e.jsx(d.Button,{onClick:$,children:"保存 SMTP 设置"}),e.jsx(ge,{}),e.jsxs(ce,{as:"h3",inverted:w,children:["配置 GitHub OAuth App",e.jsxs(ce.Subheader,{children:["用以支持通过 GitHub 进行登录注册，",e.jsx("a",{href:"https://github.com/settings/developers",target:"_blank",rel:"noreferrer",children:"点击此处"}),"管理你的 GitHub OAuth App"]})]}),e.jsxs(mu,{children:["Homepage URL 填 ",e.jsx("code",{children:u.ServerAddress}),"，Authorization callback URL 填"," ",e.jsx("code",{children:`${u.ServerAddress}/oauth/github`})]}),e.jsxs(d.Group,{widths:3,children:[e.jsx(d.Input,{label:"GitHub Client ID",name:"GitHubClientId",onChange:b,autoComplete:"new-password",value:u.GitHubClientId,placeholder:"输入你注册的 GitHub OAuth APP 的 ID"}),e.jsx(d.Input,{label:"GitHub Client Secret",name:"GitHubClientSecret",onChange:b,type:"password",autoComplete:"new-password",value:u.GitHubClientSecret,placeholder:"敏感信息不会发送到前端显示"})]}),e.jsx(d.Button,{onClick:T,children:"保存 GitHub OAuth 设置"}),e.jsx(ge,{}),e.jsxs(ce,{as:"h3",inverted:w,children:["配置 WeChat Server",e.jsxs(ce.Subheader,{children:["用以支持通过微信进行登录注册，",e.jsx("a",{href:"https://github.com/songquanpeng/wechat-server",target:"_blank",rel:"noreferrer",children:"点击此处"}),"了解 WeChat Server"]})]}),e.jsxs(d.Group,{widths:3,children:[e.jsx(d.Input,{label:"WeChat Server 服务器地址",name:"WeChatServerAddress",placeholder:"例如：https://yourdomain.com",onChange:b,autoComplete:"new-password",value:u.WeChatServerAddress}),e.jsx(d.Input,{label:"WeChat Server 访问凭证",name:"WeChatServerToken",type:"password",onChange:b,autoComplete:"new-password",value:u.WeChatServerToken,placeholder:"敏感信息不会发送到前端显示"}),e.jsx(d.Input,{label:"微信公众号二维码图片链接",name:"WeChatAccountQRCodeImageURL",onChange:b,autoComplete:"new-password",value:u.WeChatAccountQRCodeImageURL,placeholder:"输入一个图片链接"})]}),e.jsx(d.Button,{onClick:q,children:"保存 WeChat Server 设置"}),e.jsx(ge,{}),e.jsx(ce,{as:"h3",inverted:w,children:"配置 Telegram 登录"}),e.jsxs(d.Group,{inline:!0,children:[e.jsx(d.Input,{label:"Telegram Bot Token",name:"TelegramBotToken",onChange:b,value:u.TelegramBotToken,placeholder:"输入你的 Telegram Bot Token"}),e.jsx(d.Input,{label:"Telegram Bot 名称",name:"TelegramBotName",onChange:b,value:u.TelegramBotName,placeholder:"输入你的 Telegram Bot 名称"})]}),e.jsx(d.Button,{onClick:Q,children:"保存 Telegram 登录设置"}),e.jsx(ge,{}),e.jsxs(ce,{as:"h3",inverted:w,children:["配置 Turnstile",e.jsxs(ce.Subheader,{children:["用以支持用户校验，",e.jsx("a",{href:"https://dash.cloudflare.com/",target:"_blank",rel:"noreferrer",children:"点击此处"}),"管理你的 Turnstile Sites，推荐选择 Invisible Widget Type"]})]}),e.jsxs(d.Group,{widths:3,children:[e.jsx(d.Input,{label:"Turnstile Site Key",name:"TurnstileSiteKey",onChange:b,autoComplete:"new-password",value:u.TurnstileSiteKey,placeholder:"输入你注册的 Turnstile Site Key"}),e.jsx(d.Input,{label:"Turnstile Secret Key",name:"TurnstileSecretKey",onChange:b,type:"password",autoComplete:"new-password",value:u.TurnstileSecretKey,placeholder:"敏感信息不会发送到前端显示"})]}),e.jsx(d.Button,{onClick:Z,children:"保存 Turnstile 设置"})]})})})},jn=()=>{let[u,t]=n.useState({Notice:"",SystemName:"",Logo:"",Footer:"",About:"",HomePageContent:""}),[a,s]=n.useState(!1);n.useState(!1),n.useState({tag_name:"",content:""});const i=async(h,I)=>{s(!0);const $=await k.put("/api/option/",{key:h,value:I}),{success:H,message:q}=$.data;H?t(T=>({...T,[h]:I})):m(q),s(!1)},[l,c]=n.useState({Notice:!1,SystemName:!1,Logo:!1,HomePageContent:!1,About:!1,Footer:!1}),f=async(h,I)=>{const $=I.target.id;t(H=>({...H,[$]:h}))},R=n.useRef(),O=async()=>{try{c(h=>({...h,Notice:!0})),await i("Notice",u.Notice),Y("公告已更新")}catch(h){console.error("公告更新失败",h),m("公告更新失败")}finally{c(h=>({...h,Notice:!1}))}},L=n.useRef(),j=async()=>{try{c(h=>({...h,SystemName:!0})),await i("SystemName",u.SystemName),Y("系统名称已更新")}catch(h){console.error("系统名称更新失败",h),m("系统名称更新失败")}finally{c(h=>({...h,SystemName:!1}))}},_=async()=>{try{c(h=>({...h,Logo:!0})),await i("Logo",u.Logo),Y("Logo 已更新")}catch(h){console.error("Logo 更新失败",h),m("Logo 更新失败")}finally{c(h=>({...h,Logo:!1}))}},w=async h=>{try{c(I=>({...I,HomePageContent:!0})),await i(h,u[h]),Y("首页内容已更新")}catch(I){console.error("首页内容更新失败",I),m("首页内容更新失败")}finally{c(I=>({...I,HomePageContent:!1}))}},F=async()=>{try{c(h=>({...h,About:!0})),await i("About",u.About),Y("关于内容已更新")}catch(h){console.error("关于内容更新失败",h),m("关于内容更新失败")}finally{c(h=>({...h,About:!1}))}},A=async()=>{try{c(h=>({...h,Footer:!0})),await i("Footer",u.Footer),Y("页脚内容已更新")}catch(h){console.error("页脚内容更新失败",h),m("页脚内容更新失败")}finally{c(h=>({...h,Footer:!1}))}},b=async()=>{const h=await k.get("/api/option/"),{success:I,message:$,data:H}=h.data;if(I){let q={};H.forEach(T=>{T.key in u&&(q[T.key]=T.value)}),t(q),R.current.setValues(q),L.current.setValues(q)}else m($)};return n.useEffect(()=>{b()},[]),e.jsx(Et,{children:e.jsxs(Ct,{span:24,children:[e.jsx(ee,{values:u,getFormApi:h=>R.current=h,style:{marginBottom:15},children:e.jsxs(ee.Section,{text:"通用设置",children:[e.jsx(ee.TextArea,{label:"公告",placeholder:"在此输入新的公告内容，支持 Markdown & HTML 代码",field:"Notice",onChange:f,style:{fontFamily:"JetBrains Mono, Consolas"},autosize:{minRows:6,maxRows:12}}),e.jsx(v,{onClick:O,loading:l.Notice,children:"设置公告"})]})}),e.jsx(ee,{values:u,getFormApi:h=>L.current=h,style:{marginBottom:15},children:e.jsxs(ee.Section,{text:"个性化设置",children:[e.jsx(ee.Input,{label:"系统名称",placeholder:"在此输入系统名称",field:"SystemName",onChange:f}),e.jsx(v,{onClick:j,loading:l.SystemName,children:"设置系统名称"}),e.jsx(ee.Input,{label:"Logo 图片地址",placeholder:"在此输入 Logo 图片地址",field:"Logo",onChange:f}),e.jsx(v,{onClick:_,loading:l.Logo,children:"设置 Logo"}),e.jsx(ee.TextArea,{label:"首页内容",placeholder:"在此输入首页内容，支持 Markdown & HTML 代码，设置后首页的状态信息将不再显示。如果输入的是一个链接，则会使用该链接作为 iframe 的 src 属性，这允许你设置任意网页作为首页。",field:"HomePageContent",onChange:f,style:{fontFamily:"JetBrains Mono, Consolas"},autosize:{minRows:6,maxRows:12}}),e.jsx(v,{onClick:()=>w("HomePageContent"),loading:l.HomePageContent,children:"设置首页内容"}),e.jsx(ee.TextArea,{label:"关于",placeholder:"在此输入新的关于内容，支持 Markdown & HTML 代码。如果输入的是一个链接，则会使用该链接作为 iframe 的 src 属性，这允许你设置任意网页作为关于页面。",field:"About",onChange:f,style:{fontFamily:"JetBrains Mono, Consolas"},autosize:{minRows:6,maxRows:12}}),e.jsx(v,{onClick:F,loading:l.About,children:"设置关于"}),e.jsx(au,{fullMode:!1,type:"info",description:"移除 One API 的版权标识必须首先获得授权，项目维护需要花费大量精力，如果本项目对你有意义，请主动支持本项目。",closeIcon:null,style:{marginTop:15}}),e.jsx(ee.Input,{label:"页脚",placeholder:"在此输入新的页脚，留空则使用默认页脚，支持 HTML 代码",field:"Footer",onChange:f}),e.jsx(v,{onClick:A,loading:l.Footer,children:"设置页脚"})]})})]})})},fn=()=>{var iu,ru,C,D,X,ae,oe,Ee,ke,Oe,ou;const[u,t]=n.useContext(We);let a=Se();const[s,i]=n.useState({wechat_verification_code:"",email_verification_code:"",email:"",self_account_deletion_confirmation:"",set_new_password:"",set_new_password_confirmation:""}),[l,c]=n.useState({}),[f,R]=n.useState(!1),[O,L]=n.useState(!1),[j,_]=n.useState(!1),[w,F]=n.useState(!1),[A,b]=n.useState(!1),[h,I]=n.useState(""),[$,H]=n.useState(""),[q,T]=n.useState(!1),[Q,Z]=n.useState(!1),[U,M]=n.useState(30),[x,K]=n.useState(""),[W,P]=n.useState(""),[r,y]=n.useState([]),[g,J]=n.useState(!1),[ue,o]=n.useState(0);n.useEffect(()=>{let G=localStorage.getItem("status");G&&(G=JSON.parse(G),c(G),G.turnstile_check&&(b(!0),I(G.turnstile_site_key))),te().then(de=>{console.log(u)}),p().then(),z().then(),o(du())},[]),n.useEffect(()=>{let G=null;return Q&&U>0?G=setInterval(()=>{M(U-1)},1e3):U===0&&(Z(!1),M(30)),()=>clearInterval(G)},[Q,U]);const B=(G,de)=>{i(he=>({...he,[G]:de}))},E=async()=>{const G=await k.get("/api/user/token"),{success:de,message:he,data:Ie}=G.data;de?(P(Ie),await Re(Ie),Y("令牌已重置并已复制到剪贴板")):m(he)},z=async()=>{const G=await k.get("/api/user/aff"),{success:de,message:he,data:Ie}=G.data;if(de){let ct=`${window.location.origin}/register?aff=${Ie}`;K(ct)}else m(he)},te=async()=>{let G=await k.get("/api/user/self");const{success:de,message:he,data:Ie}=G.data;de?t({type:"login",payload:Ie}):m(he)},p=async()=>{let G=await k.get("/api/user/models");const{success:de,message:he,data:Ie}=G.data;de?(y(Ie),console.log(Ie)):m(he)},N=async G=>{G.target.select(),await Re(G.target.value),Y("邀请链接已复制到剪切板")},ne=async G=>{G.target.select(),await Re(G.target.value),Y("系统令牌已复制到剪切板")},me=async()=>{if(s.self_account_deletion_confirmation!==u.user.username){m("请输入你的账户名以确认删除！");return}const G=await k.delete("/api/user/self"),{success:de,message:he}=G.data;de?(Y("账户已删除！"),await k.get("/api/user/logout"),t({type:"logout"}),localStorage.removeItem("user"),a("/login")):m(he)},pe=async()=>{if(s.wechat_verification_code==="")return;const G=await k.get(`/api/oauth/wechat/bind?code=${s.wechat_verification_code}`),{success:de,message:he}=G.data;de?(Y("微信账户绑定成功！"),L(!1)):m(he)},Ce=async()=>{if(s.set_new_password!==s.set_new_password_confirmation){m("两次输入的密码不一致！");return}const G=await k.put("/api/user/self",{password:s.set_new_password}),{success:de,message:he}=G.data;de?(Y("密码修改成功！"),L(!1)):m(he),R(!1)},Ve=async()=>{if(ue<du()){m("划转金额最低为"+xe(du()));return}const G=await k.post("/api/user/aff_transfer",{quota:ue}),{success:de,message:he}=G.data;de?(Y(he),J(!1),te().then()):m(he)},Ye=async()=>{if(s.email===""){m("请输入邮箱！");return}if(Z(!0),A&&$===""){ye("请稍后几秒重试，Turnstile 正在检查用户环境！");return}T(!0);const G=await k.get(`/api/verification?email=${s.email}&turnstile=${$}`),{success:de,message:he}=G.data;de?Y("验证码发送成功，请检查邮箱！"):m(he),T(!1)},Ze=async()=>{if(s.email_verification_code===""){m("请输入邮箱验证码！");return}T(!0);const G=await k.get(`/api/oauth/email/bind?email=${s.email}&code=${s.email_verification_code}`),{success:de,message:he}=G.data;de?(Y("邮箱账户绑定成功！"),_(!1),u.user.email=s.email):m(he),T(!1)},ve=()=>u.user?u.user.username:"null",Ke=()=>{J(!1)},Cu=async G=>{await Re(G)?Y("已复制："+G):je.error({title:"无法复制到剪贴板，请手动复制",content:G})};return e.jsx("div",{children:e.jsx(le,{children:e.jsxs(le.Content,{children:[e.jsxs(je,{title:"请输入要划转的数量",visible:g,onOk:Ve,onCancel:Ke,maskClosable:!1,size:"small",centered:!0,children:[e.jsxs("div",{style:{marginTop:20},children:[e.jsx(V.Text,{children:`可用额度${uu((iu=u==null?void 0:u.user)==null?void 0:iu.aff_quota)}`}),e.jsx(se,{style:{marginTop:5},value:(ru=u==null?void 0:u.user)==null?void 0:ru.aff_quota,disabled:!0})]}),e.jsxs("div",{style:{marginTop:20},children:[e.jsx(V.Text,{children:`划转额度${uu(ue)} 最低`+xe(du())}),e.jsx("div",{children:e.jsx(Bu,{min:0,style:{marginTop:5},value:ue,onChange:G=>o(G),disabled:!1})})]})]}),e.jsxs("div",{style:{marginTop:20},children:[e.jsxs(qe,{title:e.jsx(qe.Meta,{avatar:e.jsx(_u,{size:"default",color:tu(ve()),style:{marginRight:4},children:typeof ve()=="string"&&ve().slice(0,1)}),title:e.jsx(V.Text,{children:ve()}),description:ut()?e.jsx(S,{color:"red",children:"管理员"}):e.jsx(S,{color:"blue",children:"普通用户"})}),headerExtraContent:e.jsx(e.Fragment,{children:e.jsxs(ie,{vertical:!0,align:"start",children:[e.jsx(S,{color:"green",children:"ID: "+((C=u==null?void 0:u.user)==null?void 0:C.id)}),e.jsx(S,{color:"blue",children:(D=u==null?void 0:u.user)==null?void 0:D.group})]})}),footer:e.jsxs(Me,{row:!0,children:[e.jsx(Me.Item,{itemKey:"当前余额",children:xe((X=u==null?void 0:u.user)==null?void 0:X.quota)}),e.jsx(Me.Item,{itemKey:"历史消耗",children:xe((ae=u==null?void 0:u.user)==null?void 0:ae.used_quota)}),e.jsx(Me.Item,{itemKey:"请求次数",children:(oe=u.user)==null?void 0:oe.request_count})]}),children:[e.jsx(V.Title,{heading:6,children:"可用模型"}),e.jsx("div",{style:{marginTop:10},children:e.jsx(ie,{wrap:!0,children:r.map(G=>e.jsx(S,{color:"cyan",onClick:()=>{Cu(G)},children:G},G))})})]}),e.jsxs(qe,{footer:e.jsxs("div",{children:[e.jsx(V.Text,{children:"邀请链接"}),e.jsx(se,{style:{marginTop:10},value:x,onClick:N,readOnly:!0})]}),children:[e.jsx(V.Title,{heading:6,children:"邀请信息"}),e.jsx("div",{style:{marginTop:10},children:e.jsxs(Me,{row:!0,children:[e.jsxs(Me.Item,{itemKey:"待使用收益",children:[e.jsx("span",{style:{color:"rgba(var(--semi-red-5), 1)"},children:xe((Ee=u==null?void 0:u.user)==null?void 0:Ee.aff_quota)}),e.jsx(v,{type:"secondary",onClick:()=>J(!0),size:"small",style:{marginLeft:10},children:"划转"})]}),e.jsx(Me.Item,{itemKey:"总收益",children:xe((ke=u==null?void 0:u.user)==null?void 0:ke.aff_history_quota)}),e.jsx(Me.Item,{itemKey:"邀请人数",children:(Oe=u==null?void 0:u.user)==null?void 0:Oe.aff_count})]})})]}),e.jsxs(qe,{children:[e.jsx(V.Title,{heading:6,children:"个人信息"}),e.jsxs("div",{style:{marginTop:20},children:[e.jsx(V.Text,{strong:!0,children:"邮箱"}),e.jsxs("div",{style:{display:"flex",justifyContent:"space-between"},children:[e.jsx("div",{children:e.jsx(se,{value:u.user&&u.user.email!==""?u.user.email:"未绑定",readonly:!0})}),e.jsx("div",{children:e.jsx(v,{onClick:()=>{_(!0)},children:u.user&&u.user.email!==""?"修改绑定":"绑定邮箱"})})]})]}),e.jsxs("div",{style:{marginTop:10},children:[e.jsx(V.Text,{strong:!0,children:"微信"}),e.jsxs("div",{style:{display:"flex",justifyContent:"space-between"},children:[e.jsx("div",{children:e.jsx(se,{value:u.user&&u.user.wechat_id!==""?"已绑定":"未绑定",readonly:!0})}),e.jsx("div",{children:e.jsx(v,{disabled:u.user&&u.user.wechat_id!==""||!l.wechat_login,children:l.wechat_login?"绑定":"未启用"})})]})]}),e.jsxs("div",{style:{marginTop:10},children:[e.jsx(V.Text,{strong:!0,children:"GitHub"}),e.jsxs("div",{style:{display:"flex",justifyContent:"space-between"},children:[e.jsx("div",{children:e.jsx(se,{value:u.user&&u.user.github_id!==""?u.user.github_id:"未绑定",readonly:!0})}),e.jsx("div",{children:e.jsx(v,{onClick:()=>{at(l.github_client_id)},disabled:u.user&&u.user.github_id!==""||!l.github_oauth,children:l.github_oauth?"绑定":"未启用"})})]})]}),e.jsxs("div",{style:{marginTop:10},children:[e.jsx(V.Text,{strong:!0,children:"Telegram"}),e.jsxs("div",{style:{display:"flex",justifyContent:"space-between"},children:[e.jsx("div",{children:e.jsx(se,{value:u.user&&u.user.telegram_id!==""?u.user.telegram_id:"未绑定",readonly:!0})}),e.jsx("div",{children:l.telegram_oauth?u.user.telegram_id!==""?e.jsx(v,{disabled:!0,children:"已绑定"}):e.jsx(Zu,{dataAuthUrl:"/api/oauth/telegram/bind",botName:l.telegram_bot_name}):e.jsx(v,{disabled:!0,children:"未启用"})})]})]}),e.jsxs("div",{style:{marginTop:10},children:[e.jsxs(ie,{children:[e.jsx(v,{onClick:E,children:"生成系统访问令牌"}),e.jsx(v,{onClick:()=>{R(!0)},children:"修改密码"}),e.jsx(v,{type:"danger",onClick:()=>{F(!0)},children:"删除个人账户"})]}),W&&e.jsx(se,{readOnly:!0,value:W,onClick:ne,style:{marginTop:"10px"}}),l.wechat_login&&e.jsx(v,{onClick:()=>{L(!0)},children:"绑定微信账号"}),e.jsxs(je,{onCancel:()=>L(!1),visible:O,size:"small",children:[e.jsx(jt,{src:l.wechat_qrcode}),e.jsx("div",{style:{textAlign:"center"},children:e.jsx("p",{children:"微信扫码关注公众号，输入「验证码」获取验证码（三分钟内有效）"})}),e.jsx(se,{placeholder:"验证码",name:"wechat_verification_code",value:s.wechat_verification_code,onChange:G=>B("wechat_verification_code",G)}),e.jsx(v,{color:"",fluid:!0,size:"large",onClick:pe,children:"绑定"})]})]})]}),e.jsxs(je,{onCancel:()=>_(!1),onOk:Ze,visible:j,size:"small",centered:!0,maskClosable:!1,children:[e.jsx(V.Title,{heading:6,children:"绑定邮箱地址"}),e.jsxs("div",{style:{marginTop:20,display:"flex",justifyContent:"space-between"},children:[e.jsx(se,{fluid:!0,placeholder:"输入邮箱地址",onChange:G=>B("email",G),name:"email",type:"email"}),e.jsx(v,{onClick:Ye,disabled:Q||q,children:Q?`重新发送 (${U})`:"获取验证码"})]}),e.jsx("div",{style:{marginTop:10},children:e.jsx(se,{fluid:!0,placeholder:"验证码",name:"email_verification_code",value:s.email_verification_code,onChange:G=>B("email_verification_code",G)})}),A?e.jsx(Qe,{sitekey:h,onVerify:G=>{H(G)}}):e.jsx(e.Fragment,{})]}),e.jsxs(je,{onCancel:()=>F(!1),visible:w,size:"small",centered:!0,onOk:me,children:[e.jsx("div",{style:{marginTop:20},children:e.jsx(au,{type:"danger",description:"您正在删除自己的帐户，将清空所有数据且不可恢复",closeIcon:null})}),e.jsxs("div",{style:{marginTop:20},children:[e.jsx(se,{placeholder:`输入你的账户名 ${(ou=u==null?void 0:u.user)==null?void 0:ou.username} 以确认删除`,name:"self_account_deletion_confirmation",value:s.self_account_deletion_confirmation,onChange:G=>B("self_account_deletion_confirmation",G)}),A?e.jsx(Qe,{sitekey:h,onVerify:G=>{H(G)}}):e.jsx(e.Fragment,{})]})]}),e.jsx(je,{onCancel:()=>R(!1),visible:f,size:"small",centered:!0,onOk:Ce,children:e.jsxs("div",{style:{marginTop:20},children:[e.jsx(se,{name:"set_new_password",placeholder:"新密码",value:s.set_new_password,onChange:G=>B("set_new_password",G)}),e.jsx(se,{style:{marginTop:20},name:"set_new_password_confirmation",placeholder:"确认新密码",value:s.set_new_password_confirmation,onChange:G=>B("set_new_password_confirmation",G)}),A?e.jsx(Qe,{sitekey:h,onVerify:G=>{H(G)}}):e.jsx(e.Fragment,{})]})})]})]})})})},yn=()=>{let u=new Date,[t,a]=n.useState({QuotaForNewUser:0,QuotaForInviter:0,QuotaForInvitee:0,QuotaRemindThreshold:0,PreConsumedQuota:0,StreamCacheQueueLength:0,ModelRatio:"",ModelPrice:"",GroupRatio:"",TopUpLink:"",ChatLink:"",ChatLink2:"",QuotaPerUnit:0,AutomaticDisableChannelEnabled:"",AutomaticEnableChannelEnabled:"",ChannelDisableThreshold:0,LogConsumeEnabled:"",DisplayInCurrencyEnabled:"",DisplayTokenStatEnabled:"",CheckSensitiveEnabled:"",CheckSensitiveOnPromptEnabled:"",CheckSensitiveOnCompletionEnabled:"",StopOnSensitiveEnabled:"",SensitiveWords:"",MjNotifyEnabled:"",MjAccountFilterEnabled:"",MjModeClearEnabled:"",MjForwardUrlEnabled:"",DrawingEnabled:"",DataExportEnabled:"",DataExportDefaultTime:"hour",DataExportInterval:5,DefaultCollapseSidebar:"",RetryTimes:0});const[s,i]=n.useState({});let[l,c]=n.useState(!1),[f,R]=n.useState(we(u.getTime()/1e3-30*24*3600));const O=[{key:"hour",text:"小时",value:"hour"},{key:"day",text:"天",value:"day"},{key:"week",text:"周",value:"week"}],L=async()=>{const h=await k.get("/api/option/"),{success:I,message:$,data:H}=h.data;if(I){let q={};H.forEach(T=>{(T.key==="ModelRatio"||T.key==="GroupRatio"||T.key==="ModelPrice")&&(T.value=JSON.stringify(JSON.parse(T.value),null,2)),q[T.key]=T.value}),a(q),i(q)}else m($)},_=Pu()==="dark";n.useEffect(()=>{L().then()},[]);const w=async(h,I)=>{c(!0),h.endsWith("Enabled")&&(I=t[h]==="true"?"false":"true"),h==="DefaultCollapseSidebar"&&(I=t[h]==="true"?"false":"true"),console.log(h,I);const $=await k.put("/api/option/",{key:h,value:I}),{success:H,message:q}=$.data;H?a(T=>({...T,[h]:I})):m(q),c(!1)},F=async(h,{name:I,value:$})=>{I.endsWith("Enabled")||I==="DataExportInterval"||I==="DataExportDefaultTime"||I==="DefaultCollapseSidebar"?(I==="DataExportDefaultTime"?localStorage.setItem("data_export_default_time",$):I==="MjNotifyEnabled"&&localStorage.setItem("mj_notify_enabled",$),await w(I,$)):a(H=>({...H,[I]:$}))},A=async h=>{switch(h){case"monitor":s.ChannelDisableThreshold!==t.ChannelDisableThreshold&&await w("ChannelDisableThreshold",t.ChannelDisableThreshold),s.QuotaRemindThreshold!==t.QuotaRemindThreshold&&await w("QuotaRemindThreshold",t.QuotaRemindThreshold);break;case"ratio":if(s.ModelRatio!==t.ModelRatio){if(!Xe(t.ModelRatio)){m("模型倍率不是合法的 JSON 字符串");return}await w("ModelRatio",t.ModelRatio)}if(s.GroupRatio!==t.GroupRatio){if(!Xe(t.GroupRatio)){m("分组倍率不是合法的 JSON 字符串");return}await w("GroupRatio",t.GroupRatio)}if(s.ModelPrice!==t.ModelPrice){if(!Xe(t.ModelPrice)){m("模型固定价格不是合法的 JSON 字符串");return}await w("ModelPrice",t.ModelPrice)}break;case"words":s.SensitiveWords!==t.SensitiveWords&&await w("SensitiveWords",t.SensitiveWords);break;case"quota":s.QuotaForNewUser!==t.QuotaForNewUser&&await w("QuotaForNewUser",t.QuotaForNewUser),s.QuotaForInvitee!==t.QuotaForInvitee&&await w("QuotaForInvitee",t.QuotaForInvitee),s.QuotaForInviter!==t.QuotaForInviter&&await w("QuotaForInviter",t.QuotaForInviter),s.PreConsumedQuota!==t.PreConsumedQuota&&await w("PreConsumedQuota",t.PreConsumedQuota);break;case"general":s.TopUpLink!==t.TopUpLink&&await w("TopUpLink",t.TopUpLink),s.ChatLink!==t.ChatLink&&await w("ChatLink",t.ChatLink),s.ChatLink2!==t.ChatLink2&&await w("ChatLink2",t.ChatLink2),s.QuotaPerUnit!==t.QuotaPerUnit&&await w("QuotaPerUnit",t.QuotaPerUnit),s.RetryTimes!==t.RetryTimes&&await w("RetryTimes",t.RetryTimes);break}},b=async()=>{console.log(t);const h=await k.delete(`/api/log/?target_timestamp=${Date.parse(f)/1e3}`),{success:I,message:$,data:H}=h.data;if(I){Y(`${H} 条日志已清理！`);return}m("日志清理失败："+$)};return e.jsx(Te,{columns:1,children:e.jsx(Te.Column,{children:e.jsxs(d,{loading:l,inverted:_,children:[e.jsx(ce,{as:"h3",inverted:_,children:"通用设置"}),e.jsxs(d.Group,{widths:4,children:[e.jsx(d.Input,{label:"充值链接",name:"TopUpLink",onChange:F,autoComplete:"new-password",value:t.TopUpLink,type:"link",placeholder:"例如发卡网站的购买链接"}),e.jsx(d.Input,{label:"默认聊天页面链接",name:"ChatLink",onChange:F,autoComplete:"new-password",value:t.ChatLink,type:"link",placeholder:"例如 ChatGPT Next Web 的部署地址"}),e.jsx(d.Input,{label:"聊天页面2链接",name:"ChatLink2",onChange:F,autoComplete:"new-password",value:t.ChatLink2,type:"link",placeholder:"例如 ChatGPT Web & Midjourney 的部署地址"}),e.jsx(d.Input,{label:"单位美元额度",name:"QuotaPerUnit",onChange:F,autoComplete:"new-password",value:t.QuotaPerUnit,type:"number",step:"0.01",placeholder:"一单位货币能兑换的额度"}),e.jsx(d.Input,{label:"失败重试次数",name:"RetryTimes",type:"number",step:"1",min:"0",onChange:F,autoComplete:"new-password",value:t.RetryTimes,placeholder:"失败重试次数"})]}),e.jsxs(d.Group,{inline:!0,children:[e.jsx(d.Checkbox,{checked:t.DisplayInCurrencyEnabled==="true",label:"以货币形式显示额度",name:"DisplayInCurrencyEnabled",onChange:F}),e.jsx(d.Checkbox,{checked:t.DisplayTokenStatEnabled==="true",label:"Billing 相关 API 显示令牌额度而非用户额度",name:"DisplayTokenStatEnabled",onChange:F}),e.jsx(d.Checkbox,{checked:t.DefaultCollapseSidebar==="true",label:"默认折叠侧边栏",name:"DefaultCollapseSidebar",onChange:F})]}),e.jsx(d.Button,{onClick:()=>{A("general").then()},children:"保存通用设置"}),e.jsx(ge,{}),e.jsx(ce,{as:"h3",inverted:_,children:"绘图设置"}),e.jsxs(d.Group,{inline:!0,children:[e.jsx(d.Checkbox,{checked:t.DrawingEnabled==="true",label:"启用绘图功能",name:"DrawingEnabled",onChange:F}),e.jsx(d.Checkbox,{checked:t.MjNotifyEnabled==="true",label:"允许回调（会泄露服务器ip地址）",name:"MjNotifyEnabled",onChange:F}),e.jsx(d.Checkbox,{checked:t.MjAccountFilterEnabled==="true",label:"允许AccountFilter参数",name:"MjAccountFilterEnabled",onChange:F}),e.jsx(d.Checkbox,{checked:t.MjForwardUrlEnabled==="true",label:"开启之后将上游地址替换为服务器地址",name:"MjForwardUrlEnabled",onChange:F}),e.jsx(d.Checkbox,{checked:t.MjModeClearEnabled==="true",label:"开启之后会清除用户提示词中的--fast、--relax以及--turbo参数",name:"MjModeClearEnabled",onChange:F})]}),e.jsx(ge,{}),e.jsx(ce,{as:"h3",inverted:_,children:"屏蔽词过滤设置"}),e.jsx(d.Group,{inline:!0,children:e.jsx(d.Checkbox,{checked:t.CheckSensitiveEnabled==="true",label:"启用屏蔽词过滤功能",name:"CheckSensitiveEnabled",onChange:F})}),e.jsx(d.Group,{inline:!0,children:e.jsx(d.Checkbox,{checked:t.CheckSensitiveOnPromptEnabled==="true",label:"启用prompt检查",name:"CheckSensitiveOnPromptEnabled",onChange:F})}),e.jsx(d.Group,{widths:"equal",children:e.jsx(d.TextArea,{label:"屏蔽词列表，一行一个屏蔽词，不需要符号分割",name:"SensitiveWords",onChange:F,style:{minHeight:250,fontFamily:"JetBrains Mono, Consolas"},value:t.SensitiveWords,placeholder:"一行一个屏蔽词"})}),e.jsx(d.Button,{onClick:()=>{A("words").then()},children:"保存屏蔽词设置"}),e.jsx(ge,{}),e.jsx(ce,{as:"h3",inverted:_,children:"日志设置"}),e.jsx(d.Group,{inline:!0,children:e.jsx(d.Checkbox,{checked:t.LogConsumeEnabled==="true",label:"启用额度消费日志记录",name:"LogConsumeEnabled",onChange:F})}),e.jsx(d.Group,{widths:4,children:e.jsx(d.Input,{label:"目标时间",value:f,type:"datetime-local",name:"history_timestamp",onChange:(h,{name:I,value:$})=>{R($)}})}),e.jsx(d.Button,{onClick:()=>{b().then()},children:"清理历史日志"}),e.jsx(ge,{}),e.jsx(ce,{as:"h3",inverted:_,children:"数据看板"}),e.jsx(d.Checkbox,{checked:t.DataExportEnabled==="true",label:"启用数据看板（实验性）",name:"DataExportEnabled",onChange:F}),e.jsxs(d.Group,{children:[e.jsx(d.Input,{label:"数据看板更新间隔（分钟，设置过短会影响数据库性能）",name:"DataExportInterval",type:"number",step:"1",min:"1",onChange:F,autoComplete:"new-password",value:t.DataExportInterval,placeholder:"数据看板更新间隔（分钟，设置过短会影响数据库性能）"}),e.jsx(d.Select,{label:"数据看板默认时间粒度（仅修改展示粒度，统计精确到小时）",options:O,name:"DataExportDefaultTime",onChange:F,autoComplete:"new-password",value:t.DataExportDefaultTime,placeholder:"数据看板默认时间粒度"})]}),e.jsx(ge,{}),e.jsx(ce,{as:"h3",inverted:_,children:"监控设置"}),e.jsxs(d.Group,{widths:3,children:[e.jsx(d.Input,{label:"最长响应时间",name:"ChannelDisableThreshold",onChange:F,autoComplete:"new-password",value:t.ChannelDisableThreshold,type:"number",min:"0",placeholder:"单位秒，当运行通道全部测试时，超过此时间将自动禁用通道"}),e.jsx(d.Input,{label:"额度提醒阈值",name:"QuotaRemindThreshold",onChange:F,autoComplete:"new-password",value:t.QuotaRemindThreshold,type:"number",min:"0",placeholder:"低于此额度时将发送邮件提醒用户"})]}),e.jsxs(d.Group,{inline:!0,children:[e.jsx(d.Checkbox,{checked:t.AutomaticDisableChannelEnabled==="true",label:"失败时自动禁用通道",name:"AutomaticDisableChannelEnabled",onChange:F}),e.jsx(d.Checkbox,{checked:t.AutomaticEnableChannelEnabled==="true",label:"成功时自动启用通道",name:"AutomaticEnableChannelEnabled",onChange:F})]}),e.jsx(d.Button,{onClick:()=>{A("monitor").then()},children:"保存监控设置"}),e.jsx(ge,{}),e.jsx(ce,{as:"h3",inverted:_,children:"额度设置"}),e.jsxs(d.Group,{widths:4,children:[e.jsx(d.Input,{label:"新用户初始额度",name:"QuotaForNewUser",onChange:F,autoComplete:"new-password",value:t.QuotaForNewUser,type:"number",min:"0",placeholder:"例如：100"}),e.jsx(d.Input,{label:"请求预扣费额度",name:"PreConsumedQuota",onChange:F,autoComplete:"new-password",value:t.PreConsumedQuota,type:"number",min:"0",placeholder:"请求结束后多退少补"}),e.jsx(d.Input,{label:"邀请新用户奖励额度",name:"QuotaForInviter",onChange:F,autoComplete:"new-password",value:t.QuotaForInviter,type:"number",min:"0",placeholder:"例如：2000"}),e.jsx(d.Input,{label:"新用户使用邀请码奖励额度",name:"QuotaForInvitee",onChange:F,autoComplete:"new-password",value:t.QuotaForInvitee,type:"number",min:"0",placeholder:"例如：1000"})]}),e.jsx(d.Button,{onClick:()=>{A("quota").then()},children:"保存额度设置"}),e.jsx(ge,{}),e.jsx(ce,{as:"h3",inverted:_,children:"倍率设置"}),e.jsx(d.Group,{widths:"equal",children:e.jsx(d.TextArea,{label:"模型固定价格（一次调用消耗多少刀，优先级大于模型倍率）",name:"ModelPrice",onChange:F,style:{minHeight:250,fontFamily:"JetBrains Mono, Consolas"},autoComplete:"new-password",value:t.ModelPrice,placeholder:'为一个 JSON 文本，键为模型名称，值为一次调用消耗多少刀，比如 "gpt-4-gizmo-*": 0.1，一次消耗0.1刀'})}),e.jsx(d.Group,{widths:"equal",children:e.jsx(d.TextArea,{label:"模型倍率",name:"ModelRatio",onChange:F,style:{minHeight:250,fontFamily:"JetBrains Mono, Consolas"},autoComplete:"new-password",value:t.ModelRatio,placeholder:"为一个 JSON 文本，键为模型名称，值为倍率"})}),e.jsx(d.Group,{widths:"equal",children:e.jsx(d.TextArea,{label:"分组倍率",name:"GroupRatio",onChange:F,style:{minHeight:250,fontFamily:"JetBrains Mono, Consolas"},autoComplete:"new-password",value:t.GroupRatio,placeholder:"为一个 JSON 文本，键为分组名称，值为倍率"})}),e.jsx(d.Button,{onClick:()=>{A("ratio").then()},children:"保存倍率设置"})]})})})},Bn=()=>{const u=Se(),t=Ft(),[a,s]=n.useState("1");let i=[{tab:"个人设置",content:e.jsx(fn,{}),itemKey:"personal"}];ut()&&(i.push({tab:"运营设置",content:e.jsx(yn,{}),itemKey:"operation"}),i.push({tab:"系统设置",content:e.jsx(Cn,{}),itemKey:"system"}),i.push({tab:"其他设置",content:e.jsx(jn,{}),itemKey:"other"}));const l=c=>{s(c),u(`?tab=${c}`)};return n.useEffect(()=>{const f=new URLSearchParams(window.location.search).get("tab");f?s(f):l("personal")},[t.search]),e.jsx("div",{children:e.jsx(le,{children:e.jsx(le.Content,{children:e.jsx(ft,{type:"line",activeKey:a,onChange:c=>l(c),children:i.map(c=>e.jsx(yt,{itemKey:c.itemKey,tab:c.tab,children:a===c.itemKey&&c.content},c.itemKey))})})})})},Dn=()=>{const[u,t]=n.useState({email:""}),{email:a}=u,[s,i]=n.useState(!1),[l,c]=n.useState(!1),[f,R]=n.useState(""),[O,L]=n.useState(""),[j,_]=n.useState(!1),[w,F]=n.useState(30);n.useEffect(()=>{let h=null;return j&&w>0?h=setInterval(()=>{F(w-1)},1e3):w===0&&(_(!1),F(30)),()=>clearInterval(h)},[j,w]);function A(h){const{name:I,value:$}=h.target;t(H=>({...H,[I]:$}))}async function b(h){if(_(!0),!a)return;if(l&&O===""){ye("请稍后几秒重试，Turnstile 正在检查用户环境！");return}i(!0);const I=await k.get(`/api/reset_password?email=${a}&turnstile=${O}`),{success:$,message:H}=I.data;$?(Y("重置邮件发送成功，请检查邮箱！"),t({...u,email:""})):m(H),i(!1)}return e.jsx(Te,{textAlign:"center",style:{marginTop:"48px"},children:e.jsxs(Te.Column,{style:{maxWidth:450},children:[e.jsxs(ce,{as:"h2",color:"",textAlign:"center",children:[e.jsx(Tu,{src:"/logo.png"})," 密码重置"]}),e.jsx(d,{size:"large",children:e.jsxs(gu,{children:[e.jsx(d.Input,{fluid:!0,icon:"mail",iconPosition:"left",placeholder:"邮箱地址",name:"email",value:a,onChange:A}),l?e.jsx(Qe,{sitekey:f,onVerify:h=>{L(h)}}):e.jsx(e.Fragment,{}),e.jsx(Ne,{color:"green",fluid:!0,size:"large",onClick:b,loading:s,disabled:j,children:j?`重试 (${w})`:"提交"})]})})]})})},An=()=>{const[u,t]=ku(),[a,s]=n.useContext(We),[i,l]=n.useState("处理中...");n.useState(!0);let c=Se();const f=async(R,O,L)=>{const j=await k.get(`/api/oauth/github?code=${R}&state=${O}`),{success:_,message:w,data:F}=j.data;if(_)w==="bind"?(Y("绑定成功！"),c("/setting")):(s({type:"login",payload:F}),localStorage.setItem("user",JSON.stringify(F)),Y("登录成功！"),c("/"));else{m(w);{l("操作失败，重定向至登录界面中..."),c("/setting");return}}};return n.useEffect(()=>{let R=u.get("code"),O=u.get("state");f(R,O).then()},[]),e.jsx(gu,{style:{minHeight:"300px"},children:e.jsx(Nt,{active:!0,inverted:!0,children:e.jsx(Ut,{size:"large",children:i})})})},bn=()=>{const[u,t]=n.useState({email:"",token:""}),{email:a,token:s}=u,[i,l]=n.useState(!1),[c,f]=n.useState(!1),[R,O]=n.useState(30),[L,j]=n.useState(""),[_,w]=ku();n.useEffect(()=>{let A=_.get("token"),b=_.get("email");t({token:A,email:b})},[]),n.useEffect(()=>{let A=null;return c&&R>0?A=setInterval(()=>{O(R-1)},1e3):R===0&&(f(!1),O(30)),()=>clearInterval(A)},[c,R]);async function F(A){if(f(!0),!a)return;l(!0);const b=await k.post("/api/user/reset",{email:a,token:s}),{success:h,message:I}=b.data;if(h){let $=b.data.data;j($),await Re($),$u(`新密码已复制到剪贴板：${$}`)}else m(I);l(!1)}return e.jsx(Te,{textAlign:"center",style:{marginTop:"48px"},children:e.jsxs(Te.Column,{style:{maxWidth:450},children:[e.jsxs(ce,{as:"h2",color:"",textAlign:"center",children:[e.jsx(Tu,{src:"/logo.png"})," 密码重置确认"]}),e.jsx(d,{size:"large",children:e.jsxs(gu,{children:[e.jsx(d.Input,{fluid:!0,icon:"mail",iconPosition:"left",placeholder:"邮箱地址",name:"email",value:a,readOnly:!0}),L&&e.jsx(d.Input,{fluid:!0,icon:"lock",iconPosition:"left",placeholder:"新密码",name:"newPassword",value:L,readOnly:!0,onClick:A=>{A.target.select(),navigator.clipboard.writeText(L),$u(`密码已复制到剪贴板：${L}`)}}),e.jsx(Ne,{color:"green",fluid:!0,size:"large",onClick:F,loading:i,disabled:c,children:c?"密码重置完成":"提交"})]})})]})})},Nu={"gpt-3.5-turbo-0301":"gpt-3.5-turbo","gpt-4-0314":"gpt-4","gpt-4-32k-0314":"gpt-4-32k"},Uu={400:"500"};function wn(u){switch(u){case 15:return"按照如下格式输入：APIKey|SecretKey";case 18:return"按照如下格式输入：APPID|APISecret|APIKey";case 22:return"按照如下格式输入：APIKey-AppId，例如：fastgpt-0sp2gtvfdgyi4k30jwlgwf1i-64f335d84283f05518e9e041";case 23:return"按照如下格式输入：AppId|SecretId|SecretKey";case 33:return"按照如下格式输入：Ak|Sk|Region";default:return"请输入渠道对应的鉴权密钥"}}const vu=u=>{Se();const t=u.editingChannel.id,a=t!==void 0,[s,i]=n.useState(a),l=()=>{u.handleClose()},c={name:"",type:1,key:"",openai_organization:"",max_input_tokens:0,base_url:"",other:"",model_mapping:"",status_code_mapping:"",models:[],auto_ban:1,test_model:"",groups:["default"]},[f,R]=n.useState(!1),[O,L]=n.useState(!0),[j,_]=n.useState(c),[w,F]=n.useState([]),[A,b]=n.useState([]),[h,I]=n.useState([]),[$,H]=n.useState([]),[q,T]=n.useState([]),[Q,Z]=n.useState(""),U=(r,y)=>{if(_(g=>({...g,[r]:y})),r==="type"&&j.models.length===0){let g=[];switch(y){case 33:case 14:g=["claude-instant-1.2","claude-2","claude-2.0","claude-2.1","claude-3-opus-20240229","claude-3-sonnet-20240229","claude-3-haiku-20240307"];break;case 11:g=["PaLM-2"];break;case 15:g=["ERNIE-Bot","ERNIE-Bot-turbo","ERNIE-Bot-4","Embedding-V1"];break;case 17:g=["qwen-turbo","qwen-plus","qwen-max","qwen-max-longcontext","text-embedding-v1"];break;case 16:g=["chatglm_pro","chatglm_std","chatglm_lite"];break;case 18:g=["SparkDesk","SparkDesk-v1.1","SparkDesk-v2.1","SparkDesk-v3.1","SparkDesk-v3.5"];break;case 19:g=["360GPT_S2_V9","embedding-bert-512-v1","embedding_s1_v1","semantic_similarity_s1_v1"];break;case 23:g=["hunyuan"];break;case 24:g=["gemini-1.0-pro-001","gemini-1.0-pro-vision-001","gemini-1.5-pro","gemini-1.5-pro-latest","gemini-pro","gemini-pro-vision"];break;case 34:g=["command-r","command-r-plus","command-light","command-light-nightly","command","command-nightly"];break;case 25:g=["moonshot-v1-8k","moonshot-v1-32k","moonshot-v1-128k"];break;case 26:g=["glm-4","glm-4v","glm-3-turbo"];break;case 31:g=["yi-34b-chat-0205","yi-34b-chat-200k","yi-vl-plus"];break;case 2:g=["mj_imagine","mj_variation","mj_reroll","mj_blend","mj_upscale","mj_describe"];break;case 5:g=["swap_face","mj_imagine","mj_variation","mj_reroll","mj_blend","mj_upscale","mj_describe","mj_zoom","mj_shorten","mj_modal","mj_inpaint","mj_custom_zoom","mj_high_variation","mj_low_variation","mj_pan"];break}_(J=>({...J,models:g}))}},M=async()=>{i(!0);let r=await k.get(`/api/channel/${t}`);if(r===void 0)return;const{success:y,message:g,data:J}=r.data;y?(J.models===""?J.models=[]:J.models=J.models.split(","),J.group===""?J.groups=[]:J.groups=J.group.split(","),J.model_mapping!==""&&(J.model_mapping=JSON.stringify(JSON.parse(J.model_mapping),null,2)),_(J),J.auto_ban===0?L(!1):L(!0)):m(g),i(!1)},x=async()=>{try{let r=await k.get("/api/channel/models");if(r===void 0)return;let y=r.data.data.map(g=>({label:g.id,value:g.id}));F(y),T(r.data.data.map(g=>g.id)),H(r.data.data.filter(g=>g.id.startsWith("gpt-3")||g.id.startsWith("text-")).map(g=>g.id))}catch(r){m(r.message)}},K=async()=>{try{let r=await k.get("/api/group/");if(r===void 0)return;I(r.data.data.map(y=>({label:y,value:y})))}catch(r){m(r.message)}};n.useEffect(()=>{let r=[...w];j.models.forEach(y=>{r.find(g=>g.key===y)||r.push({label:y,value:y})}),b(r)},[w,j.models]),n.useEffect(()=>{x().then(),K().then(),a?M().then(()=>{}):_(c)},[u.editingChannel.id]);const W=async()=>{if(!a&&(j.name===""||j.key==="")){ye("请填写渠道名称和渠道密钥！");return}if(j.models.length===0){ye("请至少选择一个模型！");return}if(j.model_mapping!==""&&!Xe(j.model_mapping)){ye("模型映射必须是合法的 JSON 格式！");return}let r={...j};r.base_url&&r.base_url.endsWith("/")&&(r.base_url=r.base_url.slice(0,r.base_url.length-1)),r.type===3&&r.other===""&&(r.other="2023-06-01-preview"),r.type===18&&r.other===""&&(r.other="v2.1");let y;if(!Array.isArray(r.models)){m("提交失败，请勿重复提交！"),l();return}r.auto_ban=O?1:0,r.models=r.models.join(","),r.group=r.groups.join(","),a?y=await k.put("/api/channel/",{...r,id:parseInt(t)}):y=await k.post("/api/channel/",r);const{success:g,message:J}=y.data;g?(a?Y("渠道更新成功！"):(Y("渠道创建成功！"),_(c)),u.refresh(),u.handleClose()):m(J)},P=()=>{if(Q.trim()==="")return;if(j.models.includes(Q))return m("该模型已存在！");let r=[...j.models];r.push(Q);let y=[];y.push({key:Q,text:Q,value:Q}),b(g=>[...g,...y]),Z(""),U("models",r)};return e.jsx(e.Fragment,{children:e.jsx(su,{maskClosable:!1,placement:a?"right":"left",title:e.jsx(Ge,{level:3,children:a?"更新渠道信息":"创建新的渠道"}),headerStyle:{borderBottom:"1px solid var(--semi-color-border)"},bodyStyle:{borderBottom:"1px solid var(--semi-color-border)"},visible:u.visible,footer:e.jsx("div",{style:{display:"flex",justifyContent:"flex-end"},children:e.jsxs(ie,{children:[e.jsx(v,{theme:"solid",size:"large",onClick:W,children:"提交"}),e.jsx(v,{theme:"solid",size:"large",type:"tertiary",onClick:l,children:"取消"})]})}),closeIcon:null,onCancel:()=>l(),width:Be()?"100%":600,children:e.jsxs(Ue,{spinning:s,children:[e.jsx("div",{style:{marginTop:10},children:e.jsx(V.Text,{strong:!0,children:"类型："})}),e.jsx(Ae,{name:"type",required:!0,optionList:hu,value:j.type,onChange:r=>U("type",r),style:{width:"50%"}}),j.type===3&&e.jsxs(e.Fragment,{children:[e.jsx("div",{style:{marginTop:10},children:e.jsx(au,{type:"warning",description:e.jsxs(e.Fragment,{children:["注意，",e.jsx("strong",{children:"模型部署名称必须和模型名称保持一致"}),"，因为 One API 会把请求体中的 model 参数替换为你的部署名称（模型名称中的点会被剔除），",e.jsx("a",{target:"_blank",href:"https://github.com/songquanpeng/one-api/issues/133?notification_referrer_id=NT_kwDOAmJSYrM2NjIwMzI3NDgyOjM5OTk4MDUw#issuecomment-1571602271",children:"图片演示"}),"。"]})})}),e.jsx("div",{style:{marginTop:10},children:e.jsx(V.Text,{strong:!0,children:"AZURE_OPENAI_ENDPOINT："})}),e.jsx(se,{label:"AZURE_OPENAI_ENDPOINT",name:"azure_base_url",placeholder:"请输入 AZURE_OPENAI_ENDPOINT，例如：https://docs-test-001.openai.azure.com",onChange:r=>{U("base_url",r)},value:j.base_url,autoComplete:"new-password"}),e.jsx("div",{style:{marginTop:10},children:e.jsx(V.Text,{strong:!0,children:"默认 API 版本："})}),e.jsx(se,{label:"默认 API 版本",name:"azure_other",placeholder:"请输入默认 API 版本，例如：2023-06-01-preview，该配置可以被实际的请求查询参数所覆盖",onChange:r=>{U("other",r)},value:j.other,autoComplete:"new-password"})]}),j.type===8&&e.jsxs(e.Fragment,{children:[e.jsx("div",{style:{marginTop:10},children:e.jsx(V.Text,{strong:!0,children:"Base URL："})}),e.jsx(se,{name:"base_url",placeholder:"请输入自定义渠道的 Base URL",onChange:r=>{U("base_url",r)},value:j.base_url,autoComplete:"new-password"})]}),e.jsx("div",{style:{marginTop:10},children:e.jsx(V.Text,{strong:!0,children:"名称："})}),e.jsx(se,{required:!0,name:"name",placeholder:"请为渠道命名",onChange:r=>{U("name",r)},value:j.name,autoComplete:"new-password"}),e.jsx("div",{style:{marginTop:10},children:e.jsx(V.Text,{strong:!0,children:"分组："})}),e.jsx(Ae,{placeholder:"请选择可以使用该渠道的分组",name:"groups",required:!0,multiple:!0,selection:!0,allowAdditions:!0,additionLabel:"请在系统设置页面编辑分组倍率以添加新的分组：",onChange:r=>{U("groups",r)},value:j.groups,autoComplete:"new-password",optionList:h}),j.type===18&&e.jsxs(e.Fragment,{children:[e.jsx("div",{style:{marginTop:10},children:e.jsx(V.Text,{strong:!0,children:"模型版本："})}),e.jsx(se,{name:"other",placeholder:"请输入星火大模型版本，注意是接口地址中的版本号，例如：v2.1",onChange:r=>{U("other",r)},value:j.other,autoComplete:"new-password"})]}),j.type===21&&e.jsxs(e.Fragment,{children:[e.jsx("div",{style:{marginTop:10},children:e.jsx(V.Text,{strong:!0,children:"知识库 ID："})}),e.jsx(se,{label:"知识库 ID",name:"other",placeholder:"请输入知识库 ID，例如：123456",onChange:r=>{U("other",r)},value:j.other,autoComplete:"new-password"})]}),e.jsx("div",{style:{marginTop:10},children:e.jsx(V.Text,{strong:!0,children:"模型："})}),e.jsx(Ae,{placeholder:"请选择该渠道所支持的模型",name:"models",required:!0,multiple:!0,selection:!0,onChange:r=>{U("models",r)},value:j.models,autoComplete:"new-password",optionList:A}),e.jsxs("div",{style:{lineHeight:"40px",marginBottom:"12px"},children:[e.jsxs(ie,{children:[e.jsx(v,{type:"primary",onClick:()=>{U("models",$)},children:"填入基础模型"}),e.jsx(v,{type:"secondary",onClick:()=>{U("models",q)},children:"填入所有模型"}),e.jsx(v,{type:"warning",onClick:()=>{U("models",[])},children:"清除所有模型"})]}),e.jsx(se,{addonAfter:e.jsx(v,{type:"primary",onClick:P,children:"填入"}),placeholder:"输入自定义模型名称",value:Q,onChange:r=>{Z(r.trim())}})]}),e.jsx("div",{style:{marginTop:10},children:e.jsx(V.Text,{strong:!0,children:"模型重定向："})}),e.jsx(ju,{placeholder:`此项可选，用于修改请求体中的模型名称，为一个 JSON 字符串，键为请求中模型名称，值为要替换的模型名称，例如：
${JSON.stringify(Nu,null,2)}`,name:"model_mapping",onChange:r=>{U("model_mapping",r)},autosize:!0,value:j.model_mapping,autoComplete:"new-password"}),e.jsx(V.Text,{style:{color:"rgba(var(--semi-blue-5), 1)",userSelect:"none",cursor:"pointer"},onClick:()=>{U("model_mapping",JSON.stringify(Nu,null,2))},children:"填入模板"}),e.jsx("div",{style:{marginTop:10},children:e.jsx(V.Text,{strong:!0,children:"密钥："})}),f?e.jsx(ju,{label:"密钥",name:"key",required:!0,placeholder:"请输入密钥，一行一个",onChange:r=>{U("key",r)},value:j.key,style:{minHeight:150,fontFamily:"JetBrains Mono, Consolas"},autoComplete:"new-password"}):e.jsx(se,{label:"密钥",name:"key",required:!0,placeholder:wn(j.type),onChange:r=>{U("key",r)},value:j.key,autoComplete:"new-password"}),j.type===1&&e.jsxs(e.Fragment,{children:[e.jsx("div",{style:{marginTop:10},children:e.jsx(V.Text,{strong:!0,children:"组织："})}),e.jsx(se,{label:"组织，可选，不填则为默认组织",name:"openai_organization",placeholder:"请输入组织org-xxx",onChange:r=>{U("openai_organization",r)},value:j.openai_organization})]}),e.jsx("div",{style:{marginTop:10},children:e.jsx(V.Text,{strong:!0,children:"默认测试模型："})}),e.jsx(se,{name:"test_model",placeholder:"不填则为模型列表第一个",onChange:r=>{U("test_model",r)},value:j.test_model}),e.jsx("div",{style:{marginTop:10,display:"flex"},children:e.jsxs(ie,{children:[e.jsx(Du,{name:"auto_ban",checked:O,onChange:()=>{L(!O)}}),e.jsx(V.Text,{strong:!0,children:"是否自动禁用（仅当自动禁用开启时有效），关闭后不会自动禁用该渠道："})]})}),!a&&e.jsx("div",{style:{marginTop:10,display:"flex"},children:e.jsxs(ie,{children:[e.jsx(Du,{checked:f,label:"批量创建",name:"batch",onChange:()=>R(!f)}),e.jsx(V.Text,{strong:!0,children:"批量创建"})]})}),j.type!==3&&j.type!==8&&j.type!==22&&e.jsxs(e.Fragment,{children:[e.jsx("div",{style:{marginTop:10},children:e.jsx(V.Text,{strong:!0,children:"代理："})}),e.jsx(se,{label:"代理",name:"base_url",placeholder:"此项可选，用于通过代理站来进行 API 调用",onChange:r=>{U("base_url",r)},value:j.base_url,autoComplete:"new-password"})]}),j.type===22&&e.jsxs(e.Fragment,{children:[e.jsx("div",{style:{marginTop:10},children:e.jsx(V.Text,{strong:!0,children:"私有部署地址："})}),e.jsx(se,{name:"base_url",placeholder:"请输入私有部署地址，格式为：https://fastgpt.run/api/openapi",onChange:r=>{U("base_url",r)},value:j.base_url,autoComplete:"new-password"})]}),e.jsx("div",{style:{marginTop:10},children:e.jsx(V.Text,{strong:!0,children:"状态码复写（仅影响本地判断，不修改返回到上游的状态码）："})}),e.jsx(ju,{placeholder:`此项可选，用于复写返回的状态码，比如将claude渠道的400错误复写为500（用于重试），请勿滥用该功能，例如：
${JSON.stringify(Uu,null,2)}`,name:"status_code_mapping",onChange:r=>{U("status_code_mapping",r)},autosize:!0,value:j.status_code_mapping,autoComplete:"new-password"}),e.jsx(V.Text,{style:{color:"rgba(var(--semi-blue-5), 1)",userSelect:"none",cursor:"pointer"},onClick:()=>{U("status_code_mapping",JSON.stringify(Uu,null,2))},children:"填入模板"})]})})})};let He;function Sn(u){var t,a;if(!He){He=new Map;for(let s=0;s<hu.length;s++)He[hu[s].value]=hu[s];He[0]={value:0,text:"未知类型",color:"grey"}}return e.jsx(S,{size:"large",color:(t=He[u])==null?void 0:t.color,children:(a=He[u])==null?void 0:a.text})}const vn=()=>{const u=[{title:"ID",dataIndex:"id"},{title:"名称",dataIndex:"name"},{title:"分组",dataIndex:"group",render:(C,D,X)=>e.jsx("div",{children:e.jsx(ie,{spacing:2,children:C.split(",").map((ae,oe)=>nt(ae))})})},{title:"类型",dataIndex:"type",render:(C,D,X)=>e.jsx("div",{children:Sn(C)})},{title:"状态",dataIndex:"status",render:(C,D,X)=>e.jsx("div",{children:z(C)})},{title:"响应时间",dataIndex:"response_time",render:(C,D,X)=>e.jsx("div",{children:te(C)})},{title:"已用/剩余",dataIndex:"expired_time",render:(C,D,X)=>e.jsx("div",{children:e.jsxs(ie,{spacing:1,children:[e.jsx(Le,{content:"已用额度",children:e.jsx(S,{color:"white",type:"ghost",size:"large",children:xe(D.used_quota)})}),e.jsx(Le,{content:"剩余额度"+D.balance+"，点击更新",children:e.jsxs(S,{color:"white",type:"ghost",size:"large",onClick:()=>{pe(D)},children:["$",tn(D.balance)]})})]})})},{title:"优先级",dataIndex:"priority",render:(C,D,X)=>e.jsx("div",{children:e.jsx(Bu,{style:{width:70},name:"priority",onBlur:ae=>{E(D.id,"priority",D,ae.target.value)},keepFocus:!0,innerButtons:!0,defaultValue:D.priority,min:-999})})},{title:"权重",dataIndex:"weight",render:(C,D,X)=>e.jsx("div",{children:e.jsx(Bu,{style:{width:70},name:"weight",onBlur:ae=>{E(D.id,"weight",D,ae.target.value)},keepFocus:!0,innerButtons:!0,defaultValue:D.weight,min:0})})},{title:"",dataIndex:"operate",render:(C,D,X)=>e.jsxs("div",{children:[e.jsxs(qu,{style:{marginRight:1},"aria-label":"测试操作项目组",children:[e.jsx(v,{theme:"light",onClick:()=>{N(D,"")},children:"测试"}),e.jsx($e,{trigger:"click",position:"bottomRight",menu:D.test_models,children:e.jsx(v,{style:{padding:"8px 4px"},type:"primary",icon:e.jsx(Qu,{})})})]}),e.jsx(De,{title:"确定是否要删除此渠道？",content:"此修改将不可逆",okType:"danger",position:"left",onConfirm:()=>{E(D.id,"delete",D).then(()=>{g(D.id)})},children:e.jsx(v,{theme:"light",type:"danger",style:{marginRight:1},children:"删除"})}),D.status===1?e.jsx(v,{theme:"light",type:"warning",style:{marginRight:1},onClick:async()=>{E(D.id,"disable",D)},children:"禁用"}):e.jsx(v,{theme:"light",type:"secondary",style:{marginRight:1},onClick:async()=>{E(D.id,"enable",D)},children:"启用"}),e.jsx(v,{theme:"light",type:"tertiary",style:{marginRight:1},onClick:()=>{P(D),M(!0)},children:"编辑"}),e.jsx(De,{title:"确定是否要复制此渠道？",content:"复制渠道的所有信息",okType:"danger",position:"left",onConfirm:async()=>{o(D.id)},children:e.jsx(v,{theme:"light",type:"primary",style:{marginRight:1},children:"复制"})})]})}],[t,a]=n.useState([]),[s,i]=n.useState(!0),[l,c]=n.useState(1),[f,R]=n.useState(!1),[O,L]=n.useState(""),[j,_]=n.useState(""),[w,F]=n.useState(""),[A,b]=n.useState(!1),[h,I]=n.useState(!1),[$,H]=n.useState(re);n.useState(un("channel-test"));const[q,T]=n.useState($),[Q,Z]=n.useState([]),[U,M]=n.useState(!1),[x,K]=n.useState(!1),[W,P]=n.useState({id:void 0}),[r,y]=n.useState([]),g=C=>{let D=[...t];if(C!=null){let X=D.findIndex(ae=>ae.id===C);X>-1&&(D.splice(X,1),a(D))}},J=C=>{for(let D=0;D<C.length;D++){C[D].key=""+C[D].id;let X=[];C[D].models.split(",").forEach((ae,oe)=>{X.push({node:"item",name:ae,onClick:()=>{N(C[D],ae)}})}),C[D].test_models=X}a(C),C.length>=$?T(C.length+$):T(C.length)},ue=async(C,D,X)=>{i(!0);const ae=await k.get(`/api/channel/?p=${C}&page_size=${D}&id_sort=${X}`);if(ae===void 0)return;const{success:oe,message:Ee,data:ke}=ae.data;if(oe)if(C===0)J(ke);else{let Oe=[...t];Oe.splice(C*D,ke.length,...ke),J(Oe)}else m(Ee);i(!1)},o=async C=>{const D=t.find(X=>String(X.id)===String(C));if(console.log(D),D.name+="_复制",D.created_time=null,D.balance=0,D.used_quota=0,!D){m("渠道未找到，请刷新页面后重试。");return}try{const X={...D,id:void 0},ae=await k.post("/api/channel/",X);ae.data.success?(Y("渠道复制成功"),await B()):m(ae.data.message)}catch(X){m("渠道复制失败: "+X.message)}},B=async()=>{await ue(l-1,$,f)};n.useEffect(()=>{const C=localStorage.getItem("id-sort")==="true",D=parseInt(localStorage.getItem("page-size"))||re;R(C),H(D),ue(0,D,C).then().catch(X=>{m(X)}),Cu().then()},[]);const E=async(C,D,X,ae)=>{let oe={id:C},Ee;switch(D){case"delete":Ee=await k.delete(`/api/channel/${C}/`);break;case"enable":oe.status=1,Ee=await k.put("/api/channel/",oe);break;case"disable":oe.status=2,Ee=await k.put("/api/channel/",oe);break;case"priority":if(ae==="")return;oe.priority=parseInt(ae),Ee=await k.put("/api/channel/",oe);break;case"weight":if(ae==="")return;oe.weight=parseInt(ae),oe.weight<0&&(oe.weight=0),Ee=await k.put("/api/channel/",oe);break}const{success:ke,message:Oe}=Ee.data;if(ke){Y("操作成功完成！");let ou=Ee.data.data,G=[...t];D==="delete"||(X.status=ou.status),a(G)}else m(Oe)},z=C=>{switch(C){case 1:return e.jsx(S,{size:"large",color:"green",children:"已启用"});case 2:return e.jsx(S,{size:"large",color:"yellow",children:"已禁用"});case 3:return e.jsx(S,{size:"large",color:"yellow",children:"自动禁用"});default:return e.jsx(S,{size:"large",color:"grey",children:"未知状态"})}},te=C=>{let D=C/1e3;return D=D.toFixed(2)+" 秒",C===0?e.jsx(S,{size:"large",color:"grey",children:"未测试"}):C<=1e3?e.jsx(S,{size:"large",color:"green",children:D}):C<=3e3?e.jsx(S,{size:"large",color:"lime",children:D}):C<=5e3?e.jsx(S,{size:"large",color:"yellow",children:D}):e.jsx(S,{size:"large",color:"red",children:D})},p=async(C,D,X)=>{if(C===""&&D===""&&X===""){await ue(0,$,f),c(1);return}b(!0);const ae=await k.get(`/api/channel/search?keyword=${C}&group=${D}&model=${X}`),{success:oe,message:Ee,data:ke}=ae.data;oe?(a(ke),c(1)):m(Ee),b(!1)},N=async(C,D)=>{const X=await k.get(`/api/channel/test/${C.id}?model=${D}`),{success:ae,message:oe,time:Ee}=X.data;ae?(C.response_time=Ee*1e3,C.test_time=Date.now()/1e3,ye(`通道 ${C.name} 测试成功，耗时 ${Ee.toFixed(2)} 秒。`)):m(oe)},ne=async()=>{const C=await k.get("/api/channel/test"),{success:D,message:X}=C.data;D?ye("已成功开始测试所有通道，请刷新页面查看结果。"):m(X)},me=async()=>{const C=await k.delete("/api/channel/disabled"),{success:D,message:X,data:ae}=C.data;D?(Y(`已删除所有禁用渠道，共计 ${ae} 个`),await B()):m(X)},pe=async C=>{const D=await k.get(`/api/channel/update_balance/${C.id}/`),{success:X,message:ae,balance:oe}=D.data;X?(C.balance=oe,C.balance_updated_time=Date.now()/1e3,ye(`通道 ${C.name} 余额更新成功！`)):m(ae)},Ce=async()=>{I(!0);const C=await k.get("/api/channel/update_balance"),{success:D,message:X}=C.data;D?ye("已更新完毕所有已启用通道余额！"):m(X),I(!1)},Ve=async()=>{if(r.length===0){m("请先选择要删除的通道！");return}i(!0);let C=[];r.forEach(Ee=>{C.push(Ee.id)});const D=await k.post("/api/channel/batch",{ids:C}),{success:X,message:ae,data:oe}=D.data;X?(Y(`已删除 ${oe} 个通道！`),await B()):m(ae),i(!1)},Ye=async()=>{const C=await k.post("/api/channel/fix"),{success:D,message:X,data:ae}=C.data;D?(Y(`已修复 ${ae} 个通道！`),await B()):m(X)};let Ze=t.slice((l-1)*$,l*$);const ve=C=>{c(C),C===Math.ceil(t.length/$)+1&&ue(C-1,$,f).then(D=>{})},Ke=async C=>{localStorage.setItem("page-size",C+""),H(C),c(1),ue(0,C,f).then().catch(D=>{m(D)})},Cu=async()=>{try{let C=await k.get("/api/group/");if(C===void 0)return;Z(C.data.data.map(D=>({label:D,value:D})))}catch(C){m(C.message)}},iu=()=>{M(!1)},ru=(C,D)=>C.status!==1?{style:{background:"var(--semi-color-disabled-border)"}}:{};return e.jsxs(e.Fragment,{children:[e.jsx(vu,{refresh:B,visible:U,handleClose:iu,editingChannel:W}),e.jsx(ee,{onSubmit:()=>{p(O,j,w)},labelPosition:"left",children:e.jsx("div",{style:{display:"flex"},children:e.jsxs(ie,{children:[e.jsx(ee.Input,{field:"search_keyword",label:"搜索渠道关键词",placeholder:"ID，名称和密钥 ...",value:O,loading:A,onChange:C=>{L(C.trim())}}),e.jsx(ee.Input,{field:"search_model",label:"模型",placeholder:"模型关键字",value:w,loading:A,onChange:C=>{F(C.trim())}}),e.jsx(ee.Select,{field:"group",label:"分组",optionList:Q,onChange:C=>{_(C),p(O,C,w)}}),e.jsx(v,{label:"查询",type:"primary",htmlType:"submit",className:"btn-margin-right",style:{marginRight:8},children:"查询"})]})})}),e.jsx("div",{style:{marginTop:10,display:"flex"},children:e.jsx(ie,{children:e.jsxs(ie,{children:[e.jsx(V.Text,{strong:!0,children:"使用ID排序"}),e.jsx(Au,{checked:f,label:"使用ID排序",uncheckedText:"关","aria-label":"是否用ID排序",onChange:C=>{localStorage.setItem("id-sort",C+""),R(C),ue(0,$,C).then().catch(D=>{m(D)})}})]})})}),e.jsx(Je,{className:"channel-table",style:{marginTop:15},columns:u,dataSource:Ze,pagination:{currentPage:l,pageSize:$,total:q,pageSizeOpts:[10,20,50,100],showSizeChanger:!0,formatPageText:C=>"",onPageSizeChange:C=>{Ke(C).then()},onPageChange:ve},loading:s,onRow:ru,rowSelection:x?{onChange:(C,D)=>{y(D)}}:null}),e.jsx("div",{style:{display:Be()?"":"flex",marginTop:Be()?0:-45,zIndex:999,position:"relative",pointerEvents:"none"},children:e.jsxs(ie,{style:{pointerEvents:"auto",marginTop:Be()?0:45},children:[e.jsx(v,{theme:"light",type:"primary",style:{marginRight:8},onClick:()=>{P({id:void 0}),M(!0)},children:"添加渠道"}),e.jsx(De,{title:"确定？",okType:"warning",onConfirm:ne,position:(Be(),"top"),children:e.jsx(v,{theme:"light",type:"warning",style:{marginRight:8},children:"测试所有通道"})}),e.jsx(De,{title:"确定？",okType:"secondary",onConfirm:Ce,children:e.jsx(v,{theme:"light",type:"secondary",style:{marginRight:8},children:"更新所有已启用通道余额"})}),e.jsx(De,{title:"确定是否要删除禁用通道？",content:"此修改将不可逆",okType:"danger",onConfirm:me,children:e.jsx(v,{theme:"light",type:"danger",style:{marginRight:8},children:"删除禁用通道"})}),e.jsx(v,{theme:"light",type:"primary",style:{marginRight:8},onClick:B,children:"刷新"})]})}),e.jsx("div",{style:{marginTop:20},children:e.jsxs(ie,{children:[e.jsx(V.Text,{strong:!0,children:"开启批量删除"}),e.jsx(Au,{label:"开启批量删除",uncheckedText:"关","aria-label":"是否开启批量删除",onChange:C=>{K(C)}}),e.jsx(De,{title:"确定是否要删除所选通道？",content:"此修改将不可逆",okType:"danger",onConfirm:Ve,disabled:!x,position:"top",children:e.jsx(v,{disabled:!x,theme:"light",type:"danger",style:{marginRight:8},children:"删除所选通道"})}),e.jsx(De,{title:"确定是否要修复数据库一致性？",content:"进行该操作时，可能导致渠道访问错误，请仅在数据库出现问题时使用",okType:"warning",onConfirm:Ye,position:"top",children:e.jsx(v,{theme:"light",type:"secondary",style:{marginRight:8},children:"修复数据库一致性"})})]})})]})},kn=()=>e.jsx(e.Fragment,{children:e.jsxs(le,{children:[e.jsx(le.Header,{children:e.jsx("h3",{children:"管理渠道"})}),e.jsx(le.Content,{children:e.jsx(vn,{})})]})}),_n=u=>{const[t,a]=n.useState(!1),[s,i]=n.useState(t),l={name:"",remain_quota:t?0:5e5,expired_time:-1,unlimited_quota:!1,model_limits_enabled:!1,model_limits:[]},[c,f]=n.useState(l),{name:R,remain_quota:O,expired_time:L,unlimited_quota:j,model_limits_enabled:_,model_limits:w}=c,[F,A]=n.useState({});Se();const b=(x,K)=>{f(W=>({...W,[x]:K}))},h=()=>{u.handleClose()},I=(x,K,W,P)=>{let y=new Date().getTime()/1e3,g=x*30*24*60*60;g+=K*24*60*60,g+=W*60*60,g+=P*60,g!==0?(y+=g,f({...c,expired_time:we(y)})):f({...c,expired_time:-1})},$=()=>{f({...c,unlimited_quota:!j})},H=async()=>{let x=await k.get("/api/user/models");const{success:K,message:W,data:P}=x.data;if(K){let r=P.map(y=>({label:y,value:y}));A(r)}else m(W)},q=async()=>{i(!0);let x=await k.get(`/api/token/${u.editingToken.id}`);const{success:K,message:W,data:P}=x.data;K?(P.expired_time!==-1&&(P.expired_time=we(P.expired_time)),P.model_limits!==""?P.model_limits=P.model_limits.split(","):P.model_limits=[],f(P)):m(W),i(!1)};n.useEffect(()=>{a(u.editingToken.id!==void 0)},[u.editingToken.id]),n.useEffect(()=>{t?q().then(()=>{}):f(l),H()},[t]);const[T,Q]=n.useState(1),Z=x=>{const K=parseInt(x,10);!isNaN(K)&&K>0&&Q(K)},U=()=>{const x="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";let K="";for(let W=0;W<6;W++)K+=x.charAt(Math.floor(Math.random()*x.length));return K},M=async()=>{if(i(!0),t){let x={...c};if(x.remain_quota=parseInt(x.remain_quota),x.expired_time!==-1){let r=Date.parse(x.expired_time);if(isNaN(r)){m("过期时间格式错误！"),i(!1);return}x.expired_time=Math.ceil(r/1e3)}x.model_limits=x.model_limits.join(",");let K=await k.put("/api/token/",{...x,id:parseInt(u.editingToken.id)});const{success:W,message:P}=K.data;W?(Y("令牌更新成功！"),u.refresh(),u.handleClose()):m(P)}else{let x=0;for(let K=0;K<T;K++){let W={...c};if(K!==0&&(W.name=`${c.name}-${U()}`),W.remain_quota=parseInt(W.remain_quota),W.expired_time!==-1){let g=Date.parse(W.expired_time);if(isNaN(g)){m("过期时间格式错误！"),i(!1);break}W.expired_time=Math.ceil(g/1e3)}W.model_limits=W.model_limits.join(",");let P=await k.post("/api/token/",W);const{success:r,message:y}=P.data;if(r)x++;else{m(y);break}}x>0&&(Y(`${x}个令牌创建成功，请在列表页面点击复制获取令牌！`),u.refresh(),u.handleClose())}i(!1),f(l),Q(1)};return e.jsx(e.Fragment,{children:e.jsx(su,{placement:t?"right":"left",title:e.jsx(Ge,{level:3,children:t?"更新令牌信息":"创建新的令牌"}),headerStyle:{borderBottom:"1px solid var(--semi-color-border)"},bodyStyle:{borderBottom:"1px solid var(--semi-color-border)"},visible:u.visiable,footer:e.jsx("div",{style:{display:"flex",justifyContent:"flex-end"},children:e.jsxs(ie,{children:[e.jsx(v,{theme:"solid",size:"large",onClick:M,children:"提交"}),e.jsx(v,{theme:"solid",size:"large",type:"tertiary",onClick:h,children:"取消"})]})}),closeIcon:null,onCancel:()=>h(),width:Be()?"100%":600,children:e.jsxs(Ue,{spinning:s,children:[e.jsx(se,{style:{marginTop:20},label:"名称",name:"name",placeholder:"请输入名称",onChange:x=>b("name",x),value:R,autoComplete:"new-password",required:!t}),e.jsx(ge,{}),e.jsx(Bt,{label:"过期时间",name:"expired_time",placeholder:"请选择过期时间",onChange:x=>b("expired_time",x),value:L,autoComplete:"new-password",type:"dateTime"}),e.jsx("div",{style:{marginTop:20},children:e.jsxs(ie,{children:[e.jsx(v,{type:"tertiary",onClick:()=>{I(0,0,0,0)},children:"永不过期"}),e.jsx(v,{type:"tertiary",onClick:()=>{I(0,0,1,0)},children:"一小时"}),e.jsx(v,{type:"tertiary",onClick:()=>{I(1,0,0,0)},children:"一个月"}),e.jsx(v,{type:"tertiary",onClick:()=>{I(0,1,0,0)},children:"一天"})]})}),e.jsx(ge,{}),e.jsx(au,{type:"warning",description:"注意，令牌的额度仅用于限制令牌本身的最大额度使用量，实际的使用受到账户的剩余额度限制。"}),e.jsx("div",{style:{marginTop:20},children:e.jsx(V.Text,{children:`额度${uu(O)}`})}),e.jsx(bu,{style:{marginTop:8},name:"remain_quota",placeholder:"请输入额度",onChange:x=>b("remain_quota",x),value:O,autoComplete:"new-password",type:"number",data:[{value:5e5,label:"1$"},{value:5e6,label:"10$"},{value:25e6,label:"50$"},{value:5e7,label:"100$"},{value:25e7,label:"500$"},{value:5e8,label:"1000$"}],disabled:j}),!t&&e.jsxs(e.Fragment,{children:[e.jsx("div",{style:{marginTop:20},children:e.jsx(V.Text,{children:"新建数量"})}),e.jsx(bu,{style:{marginTop:8},label:"数量",placeholder:"请选择或输入创建令牌的数量",onChange:x=>Z(x),onSelect:x=>Z(x),value:T.toString(),autoComplete:"off",type:"number",data:[{value:10,label:"10个"},{value:20,label:"20个"},{value:30,label:"30个"},{value:100,label:"100个"}],disabled:j})]}),e.jsx("div",{children:e.jsx(v,{style:{marginTop:8},type:"warning",onClick:()=>{$()},children:j?"取消无限额度":"设为无限额度"})}),e.jsx(ge,{}),e.jsx("div",{style:{marginTop:10,display:"flex"},children:e.jsxs(ie,{children:[e.jsx(Du,{name:"model_limits_enabled",checked:_,onChange:x=>b("model_limits_enabled",x.target.checked)}),e.jsx(V.Text,{children:"启用模型限制（非必要，不建议启用）"})]})}),e.jsx(Ae,{style:{marginTop:8},placeholder:"请选择该渠道所支持的模型",name:"models",required:!0,multiple:!0,selection:!0,onChange:x=>{b("model_limits",x)},value:c.model_limits,autoComplete:"new-password",optionList:F,disabled:!_})]})})})};function Gu(u){return e.jsx(e.Fragment,{children:we(u)})}function Tn(u,t=!1){switch(u){case 1:return t?e.jsx(S,{color:"green",size:"large",children:"已启用：限制模型"}):e.jsx(S,{color:"green",size:"large",children:"已启用"});case 2:return e.jsxs(S,{color:"red",size:"large",children:[" ","已禁用"," "]});case 3:return e.jsxs(S,{color:"yellow",size:"large",children:[" ","已过期"," "]});case 4:return e.jsxs(S,{color:"grey",size:"large",children:[" ","已耗尽"," "]});default:return e.jsxs(S,{color:"black",size:"large",children:[" ","未知状态"," "]})}}const In=()=>{const u=[{title:"名称",dataIndex:"name"},{title:"状态",dataIndex:"status",key:"status",render:(E,z,te)=>e.jsx("div",{children:Tn(E,z.model_limits_enabled)})},{title:"已用额度",dataIndex:"used_quota",render:(E,z,te)=>e.jsx("div",{children:xe(parseInt(E))})},{title:"剩余额度",dataIndex:"remain_quota",render:(E,z,te)=>e.jsx("div",{children:z.unlimited_quota?e.jsx(S,{size:"large",color:"white",children:"无限制"}):e.jsx(S,{size:"large",color:"light-blue",children:xe(parseInt(E))})})},{title:"创建时间",dataIndex:"created_time",render:(E,z,te)=>e.jsx("div",{children:Gu(E)})},{title:"过期时间",dataIndex:"expired_time",render:(E,z,te)=>e.jsx("div",{children:z.expired_time===-1?"永不过期":Gu(E)})},{title:"",dataIndex:"operate",render:(E,z,te)=>e.jsxs("div",{children:[e.jsx(Ju,{content:"sk-"+z.key,style:{padding:20},position:"top",children:e.jsx(v,{theme:"light",type:"tertiary",style:{marginRight:1},children:"查看"})}),e.jsx(v,{theme:"light",type:"secondary",style:{marginRight:1},onClick:async p=>{await K("sk-"+z.key)},children:"复制"}),e.jsxs(qu,{style:{marginRight:1},"aria-label":"项目操作按钮组",children:[e.jsx(v,{theme:"light",style:{color:"rgba(var(--semi-teal-7), 1)"},onClick:()=>{W("next",z.key)},children:"聊天"}),e.jsx($e,{trigger:"click",position:"bottomRight",menu:[{node:"item",key:"next",disabled:!localStorage.getItem("chat_link"),name:"ChatGPT Next Web",onClick:()=>{W("next",z.key)}},{node:"item",key:"next-mj",disabled:!localStorage.getItem("chat_link2"),name:"ChatGPT Web & Midjourney",onClick:()=>{W("next-mj",z.key)}},{node:"item",key:"ama",name:"AMA 问天（BotGem）",onClick:()=>{W("ama",z.key)}},{node:"item",key:"opencat",name:"OpenCat",onClick:()=>{W("opencat",z.key)}}],children:e.jsx(v,{style:{padding:"8px 4px",color:"rgba(var(--semi-teal-7), 1)"},type:"primary",icon:e.jsx(Qu,{})})})]}),e.jsx(De,{title:"确定是否要删除此令牌？",content:"此修改将不可逆",okType:"danger",position:"left",onConfirm:()=>{r(z.id,"delete",z).then(()=>{P(z.key)})},children:e.jsx(v,{theme:"light",type:"danger",style:{marginRight:1},children:"删除"})}),z.status===1?e.jsx(v,{theme:"light",type:"warning",style:{marginRight:1},onClick:async()=>{r(z.id,"disable",z)},children:"禁用"}):e.jsx(v,{theme:"light",type:"secondary",style:{marginRight:1},onClick:async()=>{r(z.id,"enable",z)},children:"启用"}),e.jsx(v,{theme:"light",type:"tertiary",style:{marginRight:1},onClick:()=>{T(z),i(!0)},children:"编辑"})]})}],[t,a]=n.useState(re),[s,i]=n.useState(!1),[l,c]=n.useState([]),[f,R]=n.useState([]),[O,L]=n.useState(t),[j,_]=n.useState(!0),[w,F]=n.useState(1),[A,b]=n.useState(""),[h,I]=n.useState(""),[$,H]=n.useState(!1);n.useState(!1),n.useState(0);const[q,T]=n.useState({id:void 0}),Q=()=>{i(!1),setTimeout(()=>{T({id:void 0})},500)},Z=E=>{c(E),E.length>=t?L(E.length+t):L(E.length)};let U=l.slice((w-1)*t,w*t);const M=async E=>{_(!0);const z=await k.get(`/api/token/?p=${E}&size=${t}`),{success:te,message:p,data:N}=z.data;if(te)if(E===0)Z(N);else{let ne=[...l];ne.splice(E*t,N.length,...N),Z(ne)}else m(p);_(!1)},x=async()=>{await M(w-1)},K=async E=>{await Re(E)?Y("已复制到剪贴板！"):je.error({title:"无法复制到剪贴板，请手动复制",content:E,size:"large"})},W=async(E,z)=>{let te=localStorage.getItem("status"),p="";te&&(te=JSON.parse(te),p=te.server_address),p===""&&(p=window.location.origin);let N=encodeURIComponent(p);const ne=localStorage.getItem("chat_link"),me=localStorage.getItem("chat_link2");let pe;ne&&(pe=ne+`/#/?settings={"key":"sk-${z}","url":"${p}"}`);let Ce;switch(E){case"ama":Ce=`ama://set-api-key?server=${N}&key=sk-${z}`;break;case"opencat":Ce=`opencat://team/join?domain=${N}&token=sk-${z}`;break;case"next-mj":Ce=me+`/#/?settings={"key":"sk-${z}","url":"${p}"}`;break;default:if(!ne){m("管理员未设置聊天链接");return}Ce=pe}window.open(Ce,"_blank")};n.useEffect(()=>{M(0).then().catch(E=>{m(E)})},[t]);const P=E=>{let z=[...l];if(E!=null){let te=z.findIndex(p=>p.key===E);te>-1&&(z.splice(te,1),Z(z))}},r=async(E,z,te)=>{_(!0);let p={id:E},N;switch(z){case"delete":N=await k.delete(`/api/token/${E}/`);break;case"enable":p.status=1,N=await k.put("/api/token/?status_only=true",p);break;case"disable":p.status=2,N=await k.put("/api/token/?status_only=true",p);break}const{success:ne,message:me}=N.data;if(ne){Y("操作成功完成！");let pe=N.data.data,Ce=[...l];z==="delete"||(te.status=pe.status),Z(Ce)}else m(me);_(!1)},y=async()=>{if(A===""&&h===""){await M(0),F(1);return}H(!0);const E=await k.get(`/api/token/search?keyword=${A}&token=${h}`),{success:z,message:te,data:p}=E.data;z?(Z(p),F(1)):m(te),H(!1)},g=async E=>{b(E.trim())},J=async E=>{I(E.trim())},ue=E=>{F(E),E===Math.ceil(l.length/t)+1&&M(E-1).then(z=>{})},o={onSelect:(E,z)=>{},onSelectAll:(E,z)=>{},onChange:(E,z)=>{R(z)}},B=(E,z)=>E.status!==1?{style:{background:"var(--semi-color-disabled-border)"}}:{};return e.jsxs(e.Fragment,{children:[e.jsx(_n,{refresh:x,editingToken:q,visiable:s,handleClose:Q}),e.jsxs(ee,{layout:"horizontal",style:{marginTop:10},labelPosition:"left",children:[e.jsx(ee.Input,{field:"keyword",label:"搜索关键字",placeholder:"令牌名称",value:A,loading:$,onChange:g}),e.jsx(ee.Input,{field:"token",label:"Key",placeholder:"密钥",value:h,loading:$,onChange:J}),e.jsx(v,{label:"查询",type:"primary",htmlType:"submit",className:"btn-margin-right",onClick:y,style:{marginRight:8},children:"查询"})]}),e.jsx(Je,{style:{marginTop:20},columns:u,dataSource:U,pagination:{currentPage:w,pageSize:t,total:O,showSizeChanger:!0,pageSizeOptions:[10,20,50,100],formatPageText:E=>`第 ${E.currentStart} - ${E.currentEnd} 条，共 ${l.length} 条`,onPageSizeChange:E=>{a(E),F(1)},onPageChange:ue},loading:j,rowSelection:o,onRow:B}),e.jsx(v,{theme:"light",type:"primary",style:{marginRight:8},onClick:()=>{T({id:void 0}),i(!0)},children:"添加令牌"}),e.jsx(v,{label:"复制所选令牌",type:"warning",onClick:async()=>{if(f.length===0){m("请至少选择一个令牌！");return}let E="";for(let z=0;z<f.length;z++)E+=f[z].name+"    sk-"+f[z].key+`
`;await K(E)},children:"复制所选令牌到剪贴板"})]})},Pn=()=>e.jsx(e.Fragment,{children:e.jsxs(le,{children:[e.jsx(le.Header,{children:e.jsx("h3",{children:"我的令牌"})}),e.jsx(le.Content,{children:e.jsx(In,{})})]})}),Rn=u=>{const t=u.editingRedemption.id!==void 0,[a,s]=n.useState(t);mt(),Se();const i={name:"",quota:1e5,count:1},[l,c]=n.useState(i),{name:f,quota:R,count:O}=l,L=()=>{u.handleClose()},j=(F,A)=>{c(b=>({...b,[F]:A}))},_=async()=>{s(!0);let F=await k.get(`/api/redemption/${u.editingRedemption.id}`);const{success:A,message:b,data:h}=F.data;A?c(h):m(b),s(!1)};n.useEffect(()=>{t?_().then(()=>{}):c(i)},[u.editingRedemption.id]);const w=async()=>{if(!t&&l.name==="")return;s(!0);let F=l;F.count=parseInt(F.count),F.quota=parseInt(F.quota);let A;t?A=await k.put("/api/redemption/",{...F,id:parseInt(u.editingRedemption.id)}):A=await k.post("/api/redemption/",{...F});const{success:b,message:h,data:I}=A.data;if(b?t?(Y("兑换码更新成功！"),u.refresh(),u.handleClose()):(Y("兑换码创建成功！"),c(i),u.refresh(),u.handleClose()):m(h),!t&&I){let $="";for(let H=0;H<I.length;H++)$+=I[H]+`
`;je.confirm({title:"兑换码创建成功",content:e.jsxs("div",{children:[e.jsx("p",{children:"兑换码创建成功，是否下载兑换码？"}),e.jsx("p",{children:"兑换码将以文本文件的形式下载，文件名为兑换码的名称。"})]}),onOk:()=>{en($,`${l.name}.txt`)}})}s(!1)};return e.jsx(e.Fragment,{children:e.jsx(su,{placement:t?"right":"left",title:e.jsx(Ge,{level:3,children:t?"更新兑换码信息":"创建新的兑换码"}),headerStyle:{borderBottom:"1px solid var(--semi-color-border)"},bodyStyle:{borderBottom:"1px solid var(--semi-color-border)"},visible:u.visiable,footer:e.jsx("div",{style:{display:"flex",justifyContent:"flex-end"},children:e.jsxs(ie,{children:[e.jsx(v,{theme:"solid",size:"large",onClick:w,children:"提交"}),e.jsx(v,{theme:"solid",size:"large",type:"tertiary",onClick:L,children:"取消"})]})}),closeIcon:null,onCancel:()=>L(),width:Be()?"100%":600,children:e.jsxs(Ue,{spinning:a,children:[e.jsx(se,{style:{marginTop:20},label:"名称",name:"name",placeholder:"请输入名称",onChange:F=>j("name",F),value:f,autoComplete:"new-password",required:!t}),e.jsx(ge,{}),e.jsx("div",{style:{marginTop:20},children:e.jsx(V.Text,{children:`额度${uu(R)}`})}),e.jsx(bu,{style:{marginTop:8},name:"quota",placeholder:"请输入额度",onChange:F=>j("quota",F),value:R,autoComplete:"new-password",type:"number",position:"bottom",data:[{value:5e5,label:"1$"},{value:5e6,label:"10$"},{value:25e6,label:"50$"},{value:5e7,label:"100$"},{value:25e7,label:"500$"},{value:5e8,label:"1000$"}]}),!t&&e.jsxs(e.Fragment,{children:[e.jsx(ge,{}),e.jsx(V.Text,{children:"生成数量"}),e.jsx(se,{style:{marginTop:8},label:"生成数量",name:"count",placeholder:"请输入生成数量",onChange:F=>j("count",F),value:O,autoComplete:"new-password",type:"number"})]})]})})})};function Mn(u){return e.jsx(e.Fragment,{children:we(u)})}function Ln(u){switch(u){case 1:return e.jsx(S,{color:"green",size:"large",children:"未使用"});case 2:return e.jsxs(S,{color:"red",size:"large",children:[" ","已禁用"," "]});case 3:return e.jsxs(S,{color:"grey",size:"large",children:[" ","已使用"," "]});default:return e.jsxs(S,{color:"black",size:"large",children:[" ","未知状态"," "]})}}const $n=()=>{const u=[{title:"ID",dataIndex:"id"},{title:"名称",dataIndex:"name"},{title:"状态",dataIndex:"status",key:"status",render:(y,g,J)=>e.jsx("div",{children:Ln(y)})},{title:"额度",dataIndex:"quota",render:(y,g,J)=>e.jsx("div",{children:xe(parseInt(y))})},{title:"创建时间",dataIndex:"created_time",render:(y,g,J)=>e.jsx("div",{children:Mn(y)})},{title:"兑换人ID",dataIndex:"used_user_id",render:(y,g,J)=>e.jsx("div",{children:y===0?"无":y})},{title:"",dataIndex:"operate",render:(y,g,J)=>e.jsxs("div",{children:[e.jsx(Ju,{content:g.key,style:{padding:20},position:"top",children:e.jsx(v,{theme:"light",type:"tertiary",style:{marginRight:1},children:"查看"})}),e.jsx(v,{theme:"light",type:"secondary",style:{marginRight:1},onClick:async ue=>{await Q(g.key)},children:"复制"}),e.jsx(De,{title:"确定是否要删除此兑换码？",content:"此修改将不可逆",okType:"danger",position:"left",onConfirm:()=>{U(g.id,"delete",g).then(()=>{T(g.key)})},children:e.jsx(v,{theme:"light",type:"danger",style:{marginRight:1},children:"删除"})}),g.status===1?e.jsx(v,{theme:"light",type:"warning",style:{marginRight:1},onClick:async()=>{U(g.id,"disable",g)},children:"禁用"}):e.jsx(v,{theme:"light",type:"secondary",style:{marginRight:1},onClick:async()=>{U(g.id,"enable",g)},disabled:g.status===3,children:"启用"}),e.jsx(v,{theme:"light",type:"tertiary",style:{marginRight:1},onClick:()=>{b(g),I(!0)},disabled:g.status!==1,children:"编辑"})]})}],[t,a]=n.useState([]),[s,i]=n.useState(!0),[l,c]=n.useState(1),[f,R]=n.useState(""),[O,L]=n.useState(!1),[j,_]=n.useState(re),[w,F]=n.useState([]),[A,b]=n.useState({id:void 0}),[h,I]=n.useState(!1),$=()=>{I(!1)},H=y=>{a(y),y.length>=l*re?_(y.length+1):_(y.length)},q=async y=>{const g=await k.get(`/api/redemption/?p=${y}`),{success:J,message:ue,data:o}=g.data;if(J)if(y===0)H(o);else{let B=t;B.push(...o),H(B)}else m(ue);i(!1)},T=y=>{let g=[...t];if(y!=null){let J=g.findIndex(ue=>ue.key===y);J>-1&&(g.splice(J,1),a(g))}},Q=async y=>{await Re(y)?Y("已复制到剪贴板！"):je.error({title:"无法复制到剪贴板，请手动复制",content:y})};n.useEffect(()=>{q(0).then().catch(y=>{m(y)})},[]);const Z=async()=>{await q(l-1)},U=async(y,g,J)=>{let ue={id:y},o;switch(g){case"delete":o=await k.delete(`/api/redemption/${y}/`);break;case"enable":ue.status=1,o=await k.put("/api/redemption/?status_only=true",ue);break;case"disable":ue.status=2,o=await k.put("/api/redemption/?status_only=true",ue);break}const{success:B,message:E}=o.data;if(B){Y("操作成功完成！");let z=o.data.data,te=[...t];g==="delete"||(J.status=z.status),a(te)}else m(E)},M=async()=>{if(f===""){await q(0),c(1);return}L(!0);const y=await k.get(`/api/redemption/search?keyword=${f}`),{success:g,message:J,data:ue}=y.data;g?(a(ue),c(1)):m(J),L(!1)},x=async y=>{R(y.trim())},K=y=>{c(y),y===Math.ceil(t.length/re)+1&&q(y-1).then(g=>{})};let W=t.slice((l-1)*re,l*re);const P={onSelect:(y,g)=>{},onSelectAll:(y,g)=>{},onChange:(y,g)=>{F(g)}},r=(y,g)=>y.status!==1?{style:{background:"var(--semi-color-disabled-border)"}}:{};return e.jsxs(e.Fragment,{children:[e.jsx(Rn,{refresh:Z,editingRedemption:A,visiable:h,handleClose:$}),e.jsx(ee,{onSubmit:M,children:e.jsx(ee.Input,{label:"搜索关键字",field:"keyword",icon:"search",iconPosition:"left",placeholder:"关键字(id或者名称)",value:f,loading:O,onChange:x})}),e.jsx(Je,{style:{marginTop:20},columns:u,dataSource:W,pagination:{currentPage:l,pageSize:re,total:j,formatPageText:y=>`第 ${y.currentStart} - ${y.currentEnd} 条，共 ${t.length} 条`,onPageChange:K},loading:s,rowSelection:P,onRow:r}),e.jsx(v,{theme:"light",type:"primary",style:{marginRight:8},onClick:()=>{b({id:void 0}),I(!0)},children:"添加兑换码"}),e.jsx(v,{label:"复制所选兑换码",type:"warning",onClick:async()=>{if(w.length===0){m("请至少选择一个兑换码！");return}let y="";for(let g=0;g<w.length;g++)y+=w[g].name+"    "+w[g].key+`
`;await Q(y)},children:"复制所选兑换码到剪贴板"})]})},On=()=>e.jsx(e.Fragment,{children:e.jsxs(le,{children:[e.jsx(le.Header,{children:e.jsx("h3",{children:"管理兑换码"})}),e.jsx(le.Content,{children:e.jsx($n,{})})]})}),zn=()=>{const[u,t]=n.useState(""),[a,s]=n.useState(""),[i,l]=n.useState(0);n.useState(1);const[c,f]=n.useState(0),[R,O]=n.useState(1),[L,j]=n.useState(""),[_,w]=n.useState(!1),[F,A]=n.useState(0),[b,h]=n.useState(!1),[I,$]=n.useState(!1),[H,q]=n.useState(""),T=async()=>{if(u===""){ye("请输入兑换码！");return}h(!0);try{const P=await k.post("/api/user/topup",{key:u}),{success:r,message:y,data:g}=P.data;r?(Y("兑换成功！"),je.success({title:"兑换成功！",content:"成功兑换额度："+xe(g),centered:!0}),A(J=>J+g),t("")):m(y)}catch{m("请求失败")}finally{h(!1)}},Q=()=>{if(!L){m("超级管理员未设置充值链接！");return}window.open(L,"_blank")},Z=async P=>{if(!_){m("管理员未开启在线充值！");return}if(await K(),i<R){m("充值数量不能小于"+R);return}q(P),$(!0)},U=async()=>{if(c===0&&await K(),i<R){m("充值数量不能小于"+R);return}$(!1);try{const P=await k.post("/api/user/pay",{amount:parseInt(i),top_up_code:a,payment_method:H});if(P!==void 0){const{message:r,data:y}=P.data;if(r==="success"){let g=y,J=P.data.url,ue=document.createElement("form");ue.action=J,ue.method="POST",navigator.userAgent.indexOf("Safari")>-1&&navigator.userAgent.indexOf("Chrome")<1||(ue.target="_blank");for(let B in g){let E=document.createElement("input");E.type="hidden",E.name=B,E.value=g[B],ue.appendChild(E)}document.body.appendChild(ue),ue.submit(),document.body.removeChild(ue)}else m(y)}else m(P)}catch(P){console.log(P)}finally{}},M=async()=>{let P=await k.get("/api/user/self");const{success:r,message:y,data:g}=P.data;r?A(g.quota):m(y)};n.useEffect(()=>{let P=localStorage.getItem("status");P&&(P=JSON.parse(P),P.top_up_link&&j(P.top_up_link),P.min_topup&&O(P.min_topup),P.enable_online_topup&&w(P.enable_online_topup)),M().then()},[]);const x=()=>c+"元",K=async P=>{P===void 0&&(P=i);try{const r=await k.post("/api/user/amount",{amount:parseFloat(P),top_up_code:a});if(r!==void 0){const{message:y,data:g}=r.data;y==="success"?f(parseFloat(g)):(f(0),_e.error({content:"错误："+g,id:"getAmount"}))}else m(r)}catch(r){console.log(r)}finally{}},W=()=>{$(!1)};return e.jsx("div",{children:e.jsxs(le,{children:[e.jsx(le.Header,{children:e.jsx("h3",{children:"我的钱包"})}),e.jsxs(le.Content,{children:[e.jsxs(je,{title:"确定要充值吗",visible:I,onOk:U,onCancel:W,maskClosable:!1,size:"small",centered:!0,children:[e.jsxs("p",{children:["充值数量：",i]}),e.jsxs("p",{children:["实付金额：",x()]}),e.jsx("p",{children:"是否确认充值？"})]}),e.jsx("div",{style:{marginTop:20,display:"flex",justifyContent:"center"},children:e.jsxs(qe,{style:{width:"500px",padding:"20px"},children:[e.jsxs(Ge,{level:3,style:{textAlign:"center"},children:["余额 ",xe(F)]}),e.jsxs("div",{style:{marginTop:20},children:[e.jsx(Fu,{children:"兑换余额"}),e.jsxs(ee,{children:[e.jsx(ee.Input,{field:"redemptionCode",label:"兑换码",placeholder:"兑换码",name:"redemptionCode",value:u,onChange:P=>{t(P)}}),e.jsxs(ie,{children:[L?e.jsx(v,{type:"primary",theme:"solid",onClick:Q,children:"获取兑换码"}):null,e.jsx(v,{type:"warning",theme:"solid",onClick:T,disabled:b,children:b?"兑换中...":"兑换"})]})]})]}),e.jsxs("div",{style:{marginTop:20},children:[e.jsx(Fu,{children:"在线充值"}),e.jsxs(ee,{children:[e.jsx(ee.Input,{disabled:!_,field:"redemptionCount",label:"实付金额："+x(),placeholder:"充值数量，最低 "+sn(R),name:"redemptionCount",type:"number",value:i,onChange:async P=>{P<1&&(P=1),l(P),await K(P)}}),e.jsxs(ie,{children:[e.jsx(v,{type:"primary",theme:"solid",onClick:async()=>{Z("zfb")},children:"支付宝"}),e.jsx(v,{style:{backgroundColor:"rgba(var(--semi-green-5), 1)"},type:"primary",theme:"solid",onClick:async()=>{Z("wx")},children:"微信"})]})]})]})]})})]})]})})},{Header:Nn}=le,Wu=["amber","blue","cyan","green","grey","indigo","light-blue","lime","orange","pink","purple","red","teal","violet","yellow"];function Un(u){switch(u){case 1:return e.jsxs(S,{color:"cyan",size:"large",children:[" ","充值"," "]});case 2:return e.jsxs(S,{color:"lime",size:"large",children:[" ","消费"," "]});case 3:return e.jsxs(S,{color:"orange",size:"large",children:[" ","管理"," "]});case 4:return e.jsxs(S,{color:"purple",size:"large",children:[" ","系统"," "]});default:return e.jsxs(S,{color:"black",size:"large",children:[" ","未知"," "]})}}function Gn(u){return u?e.jsx(S,{color:"blue",size:"large",children:"流"}):e.jsx(S,{color:"purple",size:"large",children:"非流"})}function Wn(u){const t=parseInt(u);return t<101?e.jsxs(S,{color:"green",size:"large",children:[" ",t," s"," "]}):t<300?e.jsxs(S,{color:"orange",size:"large",children:[" ",t," s"," "]}):e.jsxs(S,{color:"red",size:"large",children:[" ",t," s"," "]})}const Kn=()=>{const u=[{title:"时间",dataIndex:"timestamp2string"},{title:"渠道",dataIndex:"channel",className:be()?"tableShow":"tableHiddle",render:(p,N,ne)=>h?N.type===0||N.type===2?e.jsx("div",{children:e.jsxs(S,{color:Wu[parseInt(p)%Wu.length],size:"large",children:[" ",p," "]})}):e.jsx(e.Fragment,{}):e.jsx(e.Fragment,{})},{title:"用户",dataIndex:"username",className:be()?"tableShow":"tableHiddle",render:(p,N,ne)=>h?e.jsxs("div",{children:[e.jsx(_u,{size:"small",color:tu(p),style:{marginRight:4},onClick:()=>g(N.user_id),children:typeof p=="string"&&p.slice(0,1)}),p]}):e.jsx(e.Fragment,{})},{title:"令牌",dataIndex:"token_name",render:(p,N,ne)=>N.type===0||N.type===2?e.jsx("div",{children:e.jsxs(S,{color:"grey",size:"large",onClick:()=>{te(p)},children:[" ",p," "]})}):e.jsx(e.Fragment,{})},{title:"类型",dataIndex:"type",render:(p,N,ne)=>e.jsx("div",{children:Un(p)})},{title:"模型",dataIndex:"model_name",render:(p,N,ne)=>N.type===0||N.type===2?e.jsx("div",{children:e.jsxs(S,{color:tu(p),size:"large",onClick:()=>{te(p)},children:[" ",p," "]})}):e.jsx(e.Fragment,{})},{title:"用时",dataIndex:"use_time",render:(p,N,ne)=>e.jsx("div",{children:e.jsxs(ie,{children:[Wn(p),Gn(N.is_stream)]})})},{title:"提示",dataIndex:"prompt_tokens",render:(p,N,ne)=>N.type===0||N.type===2?e.jsx("div",{children:e.jsxs("span",{children:[" ",p," "]})}):e.jsx(e.Fragment,{})},{title:"补全",dataIndex:"completion_tokens",render:(p,N,ne)=>parseInt(p)>0&&(N.type===0||N.type===2)?e.jsx("div",{children:e.jsxs("span",{children:[" ",p," "]})}):e.jsx(e.Fragment,{})},{title:"花费",dataIndex:"quota",render:(p,N,ne)=>N.type===0||N.type===2?e.jsx("div",{children:xe(p,6)}):e.jsx(e.Fragment,{})},{title:"详情",dataIndex:"content",render:(p,N,ne)=>e.jsx(Dt,{ellipsis:{rows:2,showTooltip:{type:"popover",opts:{style:{width:240}}}},style:{maxWidth:240},children:p})}],[t,a]=n.useState([]),[s,i]=n.useState(!1),[l,c]=n.useState(!1),[f,R]=n.useState(!1),[O,L]=n.useState(1),[j,_]=n.useState(re),[w,F]=n.useState(re);n.useState(""),n.useState(!1);const[A,b]=n.useState(0),h=be();let I=new Date;const[$,H]=n.useState({username:"",token_name:"",model_name:"",start_timestamp:we(I.getTime()/1e3-86400),end_timestamp:we(I.getTime()/1e3+3600),channel:""}),{username:q,token_name:T,model_name:Q,start_timestamp:Z,end_timestamp:U,channel:M}=$,[x,K]=n.useState({quota:0,token:0}),W=(p,N)=>{H(ne=>({...ne,[N]:p}))},P=async()=>{let p=Date.parse(Z)/1e3,N=Date.parse(U)/1e3,ne=await k.get(`/api/log/self/stat?type=${A}&token_name=${T}&model_name=${Q}&start_timestamp=${p}&end_timestamp=${N}`);const{success:me,message:pe,data:Ce}=ne.data;me?K(Ce):m(pe)},r=async()=>{let p=Date.parse(Z)/1e3,N=Date.parse(U)/1e3,ne=await k.get(`/api/log/stat?type=${A}&username=${q}&token_name=${T}&model_name=${Q}&start_timestamp=${p}&end_timestamp=${N}&channel=${M}`);const{success:me,message:pe,data:Ce}=ne.data;me?K(Ce):m(pe)},y=async()=>{R(!0),h?await r():await P(),i(!0),R(!1)},g=async p=>{if(!h)return;const N=await k.get(`/api/user/${p}`),{success:ne,message:me,data:pe}=N.data;ne?je.info({title:"用户信息",content:e.jsxs("div",{style:{padding:12},children:[e.jsxs("p",{children:["用户名: ",pe.username]}),e.jsxs("p",{children:["余额: ",xe(pe.quota)]}),e.jsxs("p",{children:["已用额度：",xe(pe.used_quota)]}),e.jsxs("p",{children:["请求次数：",pu(pe.request_count)]})]}),centered:!0}):m(me)},J=p=>{for(let N=0;N<p.length;N++)p[N].timestamp2string=we(p[N].created_at),p[N].key=""+p[N].id;a(p),_(p.length+re)},ue=async(p,N,ne=0)=>{c(!0);let me="",pe=Date.parse(Z)/1e3,Ce=Date.parse(U)/1e3;h?me=`/api/log/?p=${p}&page_size=${N}&type=${ne}&username=${q}&token_name=${T}&model_name=${Q}&start_timestamp=${pe}&end_timestamp=${Ce}&channel=${M}`:me=`/api/log/self/?p=${p}&page_size=${N}&type=${ne}&token_name=${T}&model_name=${Q}&start_timestamp=${pe}&end_timestamp=${Ce}`;const Ve=await k.get(me),{success:Ye,message:Ze,data:ve}=Ve.data;if(Ye)if(p===0)J(ve);else{let Ke=[...t];Ke.splice(p*N,ve.length,...ve),J(Ke)}else m(Ze);c(!1)},o=t.slice((O-1)*w,O*w),B=p=>{L(p),p===Math.ceil(t.length/w)+1&&ue(p-1,w,A).then(N=>{})},E=async p=>{localStorage.setItem("page-size",p+""),F(p),L(1),ue(0,p).then().catch(N=>{m(N)})},z=async()=>{L(1),await ue(0,w,A)},te=async p=>{await Re(p)?Y("已复制："+p):je.error({title:"无法复制到剪贴板，请手动复制",content:p})};return n.useEffect(()=>{const p=parseInt(localStorage.getItem("page-size"))||re;F(p),ue(0,p).then().catch(N=>{m(N)})},[]),e.jsx(e.Fragment,{children:e.jsxs(le,{children:[e.jsx(Nn,{children:e.jsx(Ue,{spinning:f,children:e.jsxs("h3",{children:["使用明细（总消耗额度：",e.jsx("span",{onClick:y,style:{cursor:"pointer",color:"gray"},children:s?xe(x.quota):"点击查看"}),"）"]})})}),e.jsx(ee,{layout:"horizontal",style:{marginTop:10},children:e.jsxs(e.Fragment,{children:[e.jsx(ee.Input,{field:"token_name",label:"令牌名称",style:{width:176},value:T,placeholder:"可选值",name:"token_name",onChange:p=>W(p,"token_name")}),e.jsx(ee.Input,{field:"model_name",label:"模型名称",style:{width:176},value:Q,placeholder:"可选值",name:"model_name",onChange:p=>W(p,"model_name")}),e.jsx(ee.DatePicker,{field:"start_timestamp",label:"起始时间",style:{width:272},initValue:Z,value:Z,type:"dateTime",name:"start_timestamp",onChange:p=>W(p,"start_timestamp")}),e.jsx(ee.DatePicker,{field:"end_timestamp",fluid:!0,label:"结束时间",style:{width:272},initValue:U,value:U,type:"dateTime",name:"end_timestamp",onChange:p=>W(p,"end_timestamp")}),h&&e.jsxs(e.Fragment,{children:[e.jsx(ee.Input,{field:"channel",label:"渠道 ID",style:{width:176},value:M,placeholder:"可选值",name:"channel",onChange:p=>W(p,"channel")}),e.jsx(ee.Input,{field:"username",label:"用户名称",style:{width:176},value:q,placeholder:"可选值",name:"username",onChange:p=>W(p,"username")})]}),e.jsx(ee.Section,{children:e.jsx(v,{label:"查询",type:"primary",htmlType:"submit",className:"btn-margin-right",onClick:z,loading:l,children:"查询"})})]})}),e.jsx(Je,{style:{marginTop:5},columns:u,dataSource:o,pagination:{currentPage:O,pageSize:w,total:j,pageSizeOpts:[10,20,50,100],showSizeChanger:!0,onPageSizeChange:p=>{E(p).then()},onPageChange:B}}),e.jsxs(Ae,{defaultValue:"0",style:{width:120},onChange:p=>{b(parseInt(p)),ue(0,w,parseInt(p))},children:[e.jsx(Ae.Option,{value:"0",children:"全部"}),e.jsx(Ae.Option,{value:"1",children:"充值"}),e.jsx(Ae.Option,{value:"2",children:"消费"}),e.jsx(Ae.Option,{value:"3",children:"管理"}),e.jsx(Ae.Option,{value:"4",children:"系统"})]})]})})},Hn=()=>e.jsx(e.Fragment,{children:e.jsx(Kn,{})}),qn=()=>{const u=localStorage.getItem("chat_link");return e.jsx("iframe",{src:u,style:{width:"100%",height:"85vh",border:"none"}})},Ku=["amber","blue","cyan","green","grey","indigo","light-blue","lime","orange","pink","purple","red","teal","violet","yellow"];function Qn(u){switch(u){case"IMAGINE":return e.jsx(S,{color:"blue",size:"large",children:"绘图"});case"UPSCALE":return e.jsx(S,{color:"orange",size:"large",children:"放大"});case"VARIATION":return e.jsx(S,{color:"purple",size:"large",children:"变换"});case"HIGH_VARIATION":return e.jsx(S,{color:"purple",size:"large",children:"强变换"});case"LOW_VARIATION":return e.jsx(S,{color:"purple",size:"large",children:"弱变换"});case"PAN":return e.jsx(S,{color:"cyan",size:"large",children:"平移"});case"DESCRIBE":return e.jsx(S,{color:"yellow",size:"large",children:"图生文"});case"BLEND":return e.jsx(S,{color:"lime",size:"large",children:"图混合"});case"SHORTEN":return e.jsx(S,{color:"pink",size:"large",children:"缩词"});case"REROLL":return e.jsx(S,{color:"indigo",size:"large",children:"重绘"});case"INPAINT":return e.jsx(S,{color:"violet",size:"large",children:"局部重绘-提交"});case"ZOOM":return e.jsx(S,{color:"teal",size:"large",children:"变焦"});case"CUSTOM_ZOOM":return e.jsx(S,{color:"teal",size:"large",children:"自定义变焦-提交"});case"MODAL":return e.jsx(S,{color:"green",size:"large",children:"窗口处理"});case"SWAP_FACE":return e.jsx(S,{color:"light-green",size:"large",children:"换脸"});default:return e.jsx(S,{color:"white",size:"large",children:"未知"})}}function Jn(u){switch(u){case 1:return e.jsx(S,{color:"green",size:"large",children:"已提交"});case 21:return e.jsx(S,{color:"lime",size:"large",children:"等待中"});case 22:return e.jsx(S,{color:"orange",size:"large",children:"重复提交"});case 0:return e.jsx(S,{color:"yellow",size:"large",children:"未提交"});default:return e.jsx(S,{color:"white",size:"large",children:"未知"})}}function Vn(u){switch(u){case"SUCCESS":return e.jsx(S,{color:"green",size:"large",children:"成功"});case"NOT_START":return e.jsx(S,{color:"grey",size:"large",children:"未启动"});case"SUBMITTED":return e.jsx(S,{color:"yellow",size:"large",children:"队列中"});case"IN_PROGRESS":return e.jsx(S,{color:"blue",size:"large",children:"执行中"});case"FAILURE":return e.jsx(S,{color:"red",size:"large",children:"失败"});case"MODAL":return e.jsx(S,{color:"yellow",size:"large",children:"窗口等待"});default:return e.jsx(S,{color:"white",size:"large",children:"未知"})}}const Yn=u=>{const t=new Date(u*1e3),a=t.getFullYear(),s=("0"+(t.getMonth()+1)).slice(-2),i=("0"+t.getDate()).slice(-2),l=("0"+t.getHours()).slice(-2),c=("0"+t.getMinutes()).slice(-2),f=("0"+t.getSeconds()).slice(-2);return`${a}-${s}-${i} ${l}:${c}:${f}`};function Zn(u,t){if(!u||!t)return"N/A";const a=new Date(u),l=((new Date(t)-a)/1e3).toFixed(1),c=l>60?"red":"green";return e.jsxs(S,{color:c,size:"large",children:[l," 秒"]})}const Xn=()=>{const[u,t]=n.useState(!1),[a,s]=n.useState(""),i=[{title:"提交时间",dataIndex:"submit_time",render:(o,B,E)=>e.jsx("div",{children:Yn(o/1e3)})},{title:"花费时间",dataIndex:"finish_time",key:"finish_time",render:(o,B)=>Zn(B.submit_time,o)},{title:"渠道",dataIndex:"channel_id",className:be()?"tableShow":"tableHiddle",render:(o,B,E)=>e.jsx("div",{children:e.jsxs(S,{color:Ku[parseInt(o)%Ku.length],size:"large",onClick:()=>{ue(o)},children:[" ",o," "]})})},{title:"类型",dataIndex:"action",render:(o,B,E)=>e.jsx("div",{children:Qn(o)})},{title:"任务ID",dataIndex:"mj_id",render:(o,B,E)=>e.jsx("div",{children:o})},{title:"提交结果",dataIndex:"code",className:be()?"tableShow":"tableHiddle",render:(o,B,E)=>e.jsx("div",{children:Jn(o)})},{title:"任务状态",dataIndex:"status",className:be()?"tableShow":"tableHiddle",render:(o,B,E)=>e.jsx("div",{children:Vn(o)})},{title:"进度",dataIndex:"progress",render:(o,B,E)=>e.jsx("div",{children:e.jsx(At,{stroke:B.status==="FAILURE"?"var(--semi-color-warning)":null,percent:o?parseInt(o.replace("%","")):0,showInfo:!0,"aria-label":"drawing progress"})})},{title:"结果图片",dataIndex:"image_url",render:(o,B,E)=>o?e.jsx(v,{onClick:()=>{q(o),h(!0)},children:"查看图片"}):"无"},{title:"Prompt",dataIndex:"prompt",render:(o,B,E)=>o?e.jsx(V.Text,{ellipsis:{showTooltip:!0},style:{width:100},onClick:()=>{s(o),t(!0)},children:o}):"无"},{title:"PromptEn",dataIndex:"prompt_en",render:(o,B,E)=>o?e.jsx(V.Text,{ellipsis:{showTooltip:!0},style:{width:100},onClick:()=>{s(o),t(!0)},children:o}):"无"},{title:"失败原因",dataIndex:"fail_reason",render:(o,B,E)=>o?e.jsx(V.Text,{ellipsis:{showTooltip:!0},style:{width:100},onClick:()=>{s(o),t(!0)},children:o}):"无"}],[l,c]=n.useState([]),[f,R]=n.useState(!0),[O,L]=n.useState(1),[j,_]=n.useState(re),[w,F]=n.useState(0),A=be(),[b,h]=n.useState(!1),[I,$]=n.useState(!1),[H,q]=n.useState("");let T=new Date;const[Q,Z]=n.useState({channel_id:"",mj_id:"",start_timestamp:we(T.getTime()/1e3-2592e3),end_timestamp:we(T.getTime()/1e3+3600)}),{channel_id:U,mj_id:M,start_timestamp:x,end_timestamp:K}=Q;n.useState({quota:0,token:0});const W=(o,B)=>{Z(E=>({...E,[B]:o}))},P=o=>{for(let B=0;B<o.length;B++)o[B].timestamp2string=we(o[B].created_at),o[B].key=""+o[B].id;c(o),_(o.length+re)},r=async o=>{R(!0);let B="",E=Date.parse(x),z=Date.parse(K);A?B=`/api/mj/?p=${o}&channel_id=${U}&mj_id=${M}&start_timestamp=${E}&end_timestamp=${z}`:B=`/api/mj/self/?p=${o}&mj_id=${M}&start_timestamp=${E}&end_timestamp=${z}`;const te=await k.get(B),{success:p,message:N,data:ne}=te.data;if(p)if(o===0)P(ne);else{let me=[...l];me.splice(o*re,ne.length,...ne),P(me)}else m(N);R(!1)},y=l.slice((O-1)*re,O*re),g=o=>{L(o),o===Math.ceil(l.length/re)+1&&r(o-1).then(B=>{})},J=async()=>{L(1),await r(0)},ue=async o=>{await Re(o)?Y("已复制："+o):je.error({title:"无法复制到剪贴板，请手动复制",content:o})};return n.useEffect(()=>{J().then()},[w]),n.useEffect(()=>{localStorage.getItem("mj_notify_enabled")!=="true"&&$(!0)},[]),e.jsx(e.Fragment,{children:e.jsxs(le,{children:[A&&I?e.jsx(au,{type:"info",description:"当前未开启Midjourney回调，部分项目可能无法获得绘图结果，可在运营设置中开启。"}):e.jsx(e.Fragment,{}),e.jsx(ee,{layout:"horizontal",style:{marginTop:10},children:e.jsxs(e.Fragment,{children:[e.jsx(ee.Input,{field:"channel_id",label:"渠道 ID",style:{width:176},value:U,placeholder:"可选值",name:"channel_id",onChange:o=>W(o,"channel_id")}),e.jsx(ee.Input,{field:"mj_id",label:"任务 ID",style:{width:176},value:M,placeholder:"可选值",name:"mj_id",onChange:o=>W(o,"mj_id")}),e.jsx(ee.DatePicker,{field:"start_timestamp",label:"起始时间",style:{width:272},initValue:x,value:x,type:"dateTime",name:"start_timestamp",onChange:o=>W(o,"start_timestamp")}),e.jsx(ee.DatePicker,{field:"end_timestamp",fluid:!0,label:"结束时间",style:{width:272},initValue:K,value:K,type:"dateTime",name:"end_timestamp",onChange:o=>W(o,"end_timestamp")}),e.jsx(ee.Section,{children:e.jsx(v,{label:"查询",type:"primary",htmlType:"submit",className:"btn-margin-right",onClick:J,children:"查询"})})]})}),e.jsx(Je,{style:{marginTop:5},columns:i,dataSource:y,pagination:{currentPage:O,pageSize:re,total:j,pageSizeOpts:[10,20,50,100],onPageChange:g},loading:f}),e.jsx(je,{visible:u,onOk:()=>t(!1),onCancel:()=>t(!1),closable:null,bodyStyle:{height:"400px",overflow:"auto"},width:800,children:e.jsx("p",{style:{whiteSpace:"pre-line"},children:a})}),e.jsx(bt,{src:H,visible:b,onVisibleChange:o=>h(o)})]})})},es=()=>e.jsx(e.Fragment,{children:e.jsx(Xn,{})}),us=n.lazy(()=>Iu(()=>import("./index-BOasm-Qm.js"),__vite__mapDeps([0,1,2,3,4,5,6]))),ts=n.lazy(()=>Iu(()=>import("./index-DN2MlcQs.js"),__vite__mapDeps([7,1,8,2,3,4,5,6]))),ns=n.lazy(()=>Iu(()=>import("./index-BW2WmlmC.js"),__vite__mapDeps([9,1,4,2,3,5,6])));function ss(){const[u,t]=n.useContext(We),a=()=>{let s=localStorage.getItem("user");if(s){let i=JSON.parse(s);t({type:"login",payload:i})}};return n.useEffect(()=>{a();let s=Eu();s&&(document.title=s);let i=lu();if(i){let l=document.querySelector("link[rel~='icon']");l&&(l.href=i)}},[]),e.jsx(le,{children:e.jsx(le.Content,{children:e.jsxs(pt,{children:[e.jsx(Fe,{path:"/",element:e.jsx(n.Suspense,{fallback:e.jsx(fe,{}),children:e.jsx(us,{})})}),e.jsx(Fe,{path:"/channel",element:e.jsx(Pe,{children:e.jsx(kn,{})})}),e.jsx(Fe,{path:"/channel/edit/:id",element:e.jsx(n.Suspense,{fallback:e.jsx(fe,{}),children:e.jsx(vu,{})})}),e.jsx(Fe,{path:"/channel/add",element:e.jsx(n.Suspense,{fallback:e.jsx(fe,{}),children:e.jsx(vu,{})})}),e.jsx(Fe,{path:"/token",element:e.jsx(Pe,{children:e.jsx(Pn,{})})}),e.jsx(Fe,{path:"/redemption",element:e.jsx(Pe,{children:e.jsx(On,{})})}),e.jsx(Fe,{path:"/user",element:e.jsx(Pe,{children:e.jsx(on,{})})}),e.jsx(Fe,{path:"/user/edit/:id",element:e.jsx(n.Suspense,{fallback:e.jsx(fe,{}),children:e.jsx(Su,{})})}),e.jsx(Fe,{path:"/user/edit",element:e.jsx(n.Suspense,{fallback:e.jsx(fe,{}),children:e.jsx(Su,{})})}),e.jsx(Fe,{path:"/user/reset",element:e.jsx(n.Suspense,{fallback:e.jsx(fe,{}),children:e.jsx(bn,{})})}),e.jsx(Fe,{path:"/login",element:e.jsx(n.Suspense,{fallback:e.jsx(fe,{}),children:e.jsx(pn,{})})}),e.jsx(Fe,{path:"/register",element:e.jsx(n.Suspense,{fallback:e.jsx(fe,{}),children:e.jsx(cn,{})})}),e.jsx(Fe,{path:"/reset",element:e.jsx(n.Suspense,{fallback:e.jsx(fe,{}),children:e.jsx(Dn,{})})}),e.jsx(Fe,{path:"/oauth/github",element:e.jsx(n.Suspense,{fallback:e.jsx(fe,{}),children:e.jsx(An,{})})}),e.jsx(Fe,{path:"/setting",element:e.jsx(Pe,{children:e.jsx(n.Suspense,{fallback:e.jsx(fe,{}),children:e.jsx(Bn,{})})})}),e.jsx(Fe,{path:"/topup",element:e.jsx(Pe,{children:e.jsx(n.Suspense,{fallback:e.jsx(fe,{}),children:e.jsx(zn,{})})})}),e.jsx(Fe,{path:"/log",element:e.jsx(Pe,{children:e.jsx(Hn,{})})}),e.jsx(Fe,{path:"/detail",element:e.jsx(Pe,{children:e.jsx(n.Suspense,{fallback:e.jsx(fe,{}),children:e.jsx(ts,{})})})}),e.jsx(Fe,{path:"/midjourney",element:e.jsx(Pe,{children:e.jsx(n.Suspense,{fallback:e.jsx(fe,{}),children:e.jsx(es,{})})})}),e.jsx(Fe,{path:"/about",element:e.jsx(n.Suspense,{fallback:e.jsx(fe,{}),children:e.jsx(ns,{})})}),e.jsx(Fe,{path:"/chat",element:e.jsx(n.Suspense,{fallback:e.jsx(fe,{}),children:e.jsx(qn,{})})}),e.jsx(Fe,{path:"*",element:e.jsx(gn,{})})]})})})}localStorage.getItem("chat_link");const as=()=>{const[u,t]=n.useContext(We);let a=Se();const[s,i]=n.useState(!1);Eu(),lu();const l=new Date,c=l.getMonth()===0&&l.getDate()===1||l.getMonth()===1&&l.getDate()>=9&&l.getDate()<=24;async function f(){i(!1),await k.get("/api/user/logout"),Y("注销成功!"),t({type:"logout"}),localStorage.removeItem("user"),a("/login")}const R=()=>{fu.init("root",{}),fu.start(),setTimeout(()=>{fu.stop(),setTimeout(()=>{window.location.reload()},1e4)},3e3)},O=Pu(),L=xn();return n.useEffect(()=>{O==="dark"&&document.body.setAttribute("theme-mode","dark"),c&&console.log("Happy New Year!")},[]),e.jsx(e.Fragment,{children:e.jsx(le,{children:e.jsx("div",{style:{width:"100%"},children:e.jsx(ze,{mode:"horizontal",renderWrapper:({itemElement:j,isSubNav:_,isInSubNav:w,props:F})=>{const A={about:"/about",login:"/login",register:"/register"};return e.jsx(eu,{style:{textDecoration:"none"},to:A[F.itemKey],children:j})},selectedKeys:[],onSelect:j=>{},footer:e.jsxs(e.Fragment,{children:[c&&e.jsx($e,{position:"bottomRight",render:e.jsx($e.Menu,{children:e.jsx($e.Item,{onClick:R,children:"Happy New Year!!!"})}),children:e.jsx(ze.Item,{itemKey:"new-year",text:"🏮"})}),e.jsx(ze.Item,{itemKey:"about",icon:e.jsx(wt,{})}),e.jsx(Au,{checkedText:"🌞",size:"large",checked:O==="dark",uncheckedText:"🌙",onChange:j=>{L(j)}}),u.user?e.jsx(e.Fragment,{children:e.jsxs($e,{position:"bottomRight",render:e.jsx($e.Menu,{children:e.jsx($e.Item,{onClick:f,children:"退出"})}),children:[e.jsx(_u,{size:"small",color:tu(u.user.username),style:{margin:4},children:u.user.username[0]}),e.jsx("span",{children:u.user.username})]})}):e.jsxs(e.Fragment,{children:[e.jsx(ze.Item,{itemKey:"login",text:"登录",icon:e.jsx(Vu,{})}),e.jsx(ze.Item,{itemKey:"register",text:"注册",icon:e.jsx(Yu,{})})]})]})})})})})},ls=()=>{Eu();const[u,t]=n.useState(Xt());let a=5;const s=()=>{let i=localStorage.getItem("footer_html");i&&t(i)};return n.useEffect(()=>{const i=setInterval(()=>{if(a<=0){clearInterval(i);return}a--,s()},200);return()=>clearTimeout(i)},[]),e.jsx(le,{children:e.jsx(le.Content,{style:{textAlign:"center"},children:u?e.jsx("div",{className:"custom-footer",dangerouslySetInnerHTML:{__html:u}}):e.jsxs("div",{className:"custom-footer",children:[e.jsxs("a",{href:"https://github.com/Calcium-Ion/new-api",target:"_blank",rel:"noreferrer",children:["New API ",""," "]}),"由"," ",e.jsx("a",{href:"https://github.com/Calcium-Ion",target:"_blank",rel:"noreferrer",children:"Calcium-Ion"})," ","开发，基于"," ",e.jsx("a",{href:"https://github.com/songquanpeng/one-api",target:"_blank",rel:"noreferrer",children:"One API v0.5.4"})," ","，本项目根据"," ",e.jsx("a",{href:"https://opensource.org/licenses/mit-license.php",children:"MIT 许可证"})," ","授权"]})})})},is=(u,t)=>{switch(t.type){case"set":return{...u,status:t.payload};case"unset":return{...u,status:void 0};default:return u}},rt={status:void 0},ot=nu.createContext({state:rt,dispatch:()=>null}),rs=({children:u})=>{const[t,a]=nu.useReducer(is,rt);return e.jsx(ot.Provider,{value:[t,a],children:u})},os=()=>{n.useContext(We);const[u,t]=n.useContext(ot),a=Be()||localStorage.getItem("default_collapse_sidebar")==="true";Se();const[s,i]=n.useState(["home"]),l=Eu(),c=lu(),[f,R]=n.useState(a),O={home:"/",channel:"/channel",token:"/token",redemption:"/redemption",topup:"/topup",user:"/user",log:"/log",midjourney:"/midjourney",setting:"/setting",about:"/about",chat:"/chat",detail:"/detail"},L=n.useMemo(()=>[{text:"首页",itemKey:"home",to:"/",icon:e.jsx(St,{})},{text:"渠道",itemKey:"channel",to:"/channel",icon:e.jsx(vt,{}),className:be()?"semi-navigation-item-normal":"tableHiddle"},{text:"聊天",itemKey:"chat",to:"/chat",icon:e.jsx(kt,{}),className:localStorage.getItem("chat_link")?"semi-navigation-item-normal":"tableHiddle"},{text:"令牌",itemKey:"token",to:"/token",icon:e.jsx(Vu,{})},{text:"兑换码",itemKey:"redemption",to:"/redemption",icon:e.jsx(_t,{}),className:be()?"semi-navigation-item-normal":"tableHiddle"},{text:"钱包",itemKey:"topup",to:"/topup",icon:e.jsx(Tt,{})},{text:"用户管理",itemKey:"user",to:"/user",icon:e.jsx(Yu,{}),className:be()?"semi-navigation-item-normal":"tableHiddle"},{text:"日志",itemKey:"log",to:"/log",icon:e.jsx(It,{})},{text:"数据看板",itemKey:"detail",to:"/detail",icon:e.jsx(Pt,{}),className:localStorage.getItem("enable_data_export")==="true"?"semi-navigation-item-normal":"tableHiddle"},{text:"绘图",itemKey:"midjourney",to:"/midjourney",icon:e.jsx(Rt,{}),className:localStorage.getItem("enable_drawing")==="true"?"semi-navigation-item-normal":"tableHiddle"},{text:"设置",itemKey:"setting",to:"/setting",icon:e.jsx(Mt,{})}],[localStorage.getItem("enable_data_export"),localStorage.getItem("enable_drawing"),localStorage.getItem("chat_link"),be()]),j=async()=>{const _=await k.get("/api/status");if(_===void 0)return;const{success:w,data:F}=_.data;w?(localStorage.setItem("status",JSON.stringify(F)),t({type:"set",payload:F}),localStorage.setItem("system_name",F.system_name),localStorage.setItem("logo",F.logo),localStorage.setItem("footer_html",F.footer_html),localStorage.setItem("quota_per_unit",F.quota_per_unit),localStorage.setItem("display_in_currency",F.display_in_currency),localStorage.setItem("enable_drawing",F.enable_drawing),localStorage.setItem("enable_data_export",F.enable_data_export),localStorage.setItem("data_export_default_time",F.data_export_default_time),localStorage.setItem("default_collapse_sidebar",F.default_collapse_sidebar),localStorage.setItem("mj_notify_enabled",F.mj_notify_enabled),F.chat_link?localStorage.setItem("chat_link",F.chat_link):localStorage.removeItem("chat_link"),F.chat_link2?localStorage.setItem("chat_link2",F.chat_link2):localStorage.removeItem("chat_link2")):m("无法正常连接至服务器！")};return n.useEffect(()=>{j().then(()=>{R(Be()||localStorage.getItem("default_collapse_sidebar")==="true")});let _=window.location.pathname.split("/")[1];_===""&&(_="home"),i([_])},[]),e.jsx(e.Fragment,{children:e.jsx(le,{children:e.jsx("div",{style:{height:"100%"},children:e.jsx(ze,{style:{maxWidth:200},defaultIsCollapsed:Be()||localStorage.getItem("default_collapse_sidebar")==="true",isCollapsed:f,onCollapseChange:_=>{R(_)},selectedKeys:s,renderWrapper:({itemElement:_,isSubNav:w,isInSubNav:F,props:A})=>e.jsx(eu,{style:{textDecoration:"none"},to:O[A.itemKey],children:_}),items:L,onSelect:_=>{i([_.itemKey])},header:{logo:e.jsx("img",{src:c,alt:"logo",style:{marginRight:"0.75em"}}),text:l},children:e.jsx(ze.Footer,{collapseButton:!0})})})})})},cs=wu.createRoot(document.getElementById("root")),{Sider:ds,Content:hs,Header:Fs}=le;cs.render(e.jsx(nu.StrictMode,{children:e.jsx(rs,{children:e.jsx(hn,{children:e.jsx(gt,{children:e.jsx(En,{children:e.jsxs(le,{children:[e.jsx(ds,{children:e.jsx(os,{})}),e.jsxs(le,{children:[e.jsx(Fs,{children:e.jsx(as,{})}),e.jsx(hs,{style:{padding:"24px"},children:e.jsx(ss,{})}),e.jsx(le.Footer,{children:e.jsx(ls,{})})]}),e.jsx(zt,{})]})})})})})}));export{k as A,ot as S,m as a,pu as b,Cs as c,xe as d,fs as g,be as i,e as j,ys as m,js as r,$u as s,we as t};
